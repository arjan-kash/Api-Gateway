"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.CDRService=void 0;var logger_util_1=require("../utils/logger.util"),api_logs_1=require("../utils/api-logs"),constant_1=require("../utils/constant"),knex=require("../dba/knex.db"),CDRService=function(){function e(){this.apiInstance=new api_logs_1.ApiLogs}return e.prototype.getExtensionCDR=function(t,l,e){var s,a,n,i,o=this;"6"==(t.user_type||1)?(a=(s=t.body).missed_call?Number(s.missed_call):null,s.company=s.company?"'"+s.company+"'":null,s.sellcost=s.sellcost?"'"+s.sellcost+"'":null,s.caller=s.caller?"'"+s.caller+"'":null,s.callee=s.callee?"'"+s.callee+"'":null,s.callcost=s.callcost?"'"+s.callcost+"'":null,s.destination=s.destination?"'"+s.destination+"'":null,s.callerid=s.callerid?"'"+s.callerid+"'":null,n=s.date_from?"'"+s.date_from+"'":null,i=s.date_to?"'"+s.date_to+"'":null,s.call_type=s.call_type?"'"+s.call_type+"'":null,s.uuid=s.uuid?"'"+s.uuid+"'":null,s.terminatecause=a?"'486,480,487'":s.terminatecause&&s.terminatecause.length?"'"+s.terminatecause+"'":null,s.page_per_size=s.page_per_size?"'"+s.page_per_size+"'":null,s.page_number=s.page_number?"'"+s.page_number+"'":null,s.callerid=s.callerid?"'"+s.callerid+"'":null,console.log(knex.raw("Call pbx_getExtensionCdrByFilters("+n+","+i+","+t.id+","+s.callcost+","+s.sellcost+","+s.caller+","+s.callee+","+s.destination+","+s.callerid+","+s.terminatecause+","+s.call_type+","+s.page_per_size+","+s.page_number+","+s.uuid+")").toString()),knex.raw("Call pbx_getExtensionCdrByFilters("+n+","+i+","+t.id+","+s.callcost+","+s.sellcost+","+s.caller+","+s.callee+","+s.destination+","+s.callerid+","+s.terminatecause+","+s.call_type+","+s.page_per_size+","+s.page_number+","+s.uuid+")").then(function(e){e[0][0].length?((e[0][0]||[]).map(function(e){return delete e.id,delete e.hangup_disposition,e.caller=e.src,delete e.src,e.date_from=e.startTime,e.date_to=e.endTime,delete e.startTime,delete e.endTime,delete e.buyCost,e.endpoint=e.dispDst,delete e.dispDst,e.sellcost=e.sellCost,delete e.sellCost,e.callcost=e.callCost,delete e.callCost,e.bridgetime=e.bridgeTime,delete e.bridgeTime,e.sessiontime=e.sessionTime,delete e.sessionTime,e.callplanname=e.callPlanName,delete e.callPlanName,e.gatewayname=e.gatewayName,delete e.gatewayName,e.dispcallerid=e.dispCallerId,delete e.dispCallerId,e.termdescription=e.termDescription,delete e.termDescription,e.dispdestination=e.dispDestination,delete e.dispDestination,e}),l.send({status_code:200,message:"Extension CDR list.",data:e[0][0]}),o.apiInstance.log(200,"Extension CDR list.","getExtensionCDR","pbx",t.customer_id,t.ext_number)):(l.send({status_code:201,message:"No Data found.",data:[]}),o.apiInstance.log(201,"No Data found.","getExtensionCDR","pbx",t.customer_id,t.ext_number))}).catch(function(e){throw logger_util_1.errorLog(e),l.status(400).send({status_code:400,message:"Bad Request"}),o.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getExtensionCDR","pbx",t.customer_id,t.ext_number),e})):(this.apiInstance.log(403,"Forbidden - User has no permission for perform this action.","getMinutePlan","pbx","","",""),l.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for perform this action"}))},e.prototype.getCustomerCDR=function(t,l,e){var s,a,n,i,o=this;"1"==(t.user_type||1)?(a=(s=t.body).missed_call?Number(s.missed_call):null,s.company=s.company?"'"+s.company+"'":null,s.sellcost=s.sellcost?"'"+s.sellcost+"'":null,s.caller=s.caller?"'"+s.caller+"'":null,s.callee=s.callee?"'"+s.callee+"'":null,s.callcost=s.callcost?"'"+s.callcost+"'":null,s.destination=s.destination?"'"+s.destination+"'":null,s.callerid=s.callerid?"'"+s.callerid+"'":null,n=s.date_from?"'"+s.date_from+"'":null,i=s.date_to?"'"+s.date_to+"'":null,s.call_type=s.call_type?"'"+s.call_type+"'":null,s.terminatecause=a?"'486,480,487'":s.terminatecause&&s.terminatecause.length?"'"+s.terminatecause+"'":null,s.page_per_size=s.page_per_size?Number(s.page_per_size):null,s.page_number=s.page_number?Number(s.page_number):null,console.log(knex.raw("Call pbx_getCustomerCdrByFilters("+n+","+i+","+t.id+","+s.callcost+","+s.sellcost+","+s.caller+","+s.callee+","+s.destination+","+s.callerid+","+s.terminatecause+","+s.call_type+","+s.page_per_size+","+s.page_number+")").toString()),knex.raw("Call pbx_getCustomerCdrByFilters("+n+","+i+","+t.id+","+s.callcost+","+s.sellcost+","+s.caller+","+s.callee+","+s.destination+","+s.callerid+","+s.terminatecause+","+s.call_type+","+s.page_per_size+","+s.page_number+")").then(function(e){e[0][0].length?((e[0][0]||[]).map(function(e){return delete e.id,delete e.hangup_disposition,e.caller=e.src,delete e.src,e.date_from=e.startTime,e.date_to=e.endTime,delete e.startTime,delete e.endTime,delete e.buyCost,e.endpoint=e.dispDst,delete e.dispDst,e.sellcost=e.sellCost,delete e.sellCost,e.callcost=e.callCost,delete e.callCost,e.bridgetime=e.bridgeTime,delete e.bridgeTime,e.sessiontime=e.sessionTime,delete e.sessionTime,e.callplanname=e.callPlanName,delete e.callPlanName,e.gatewayname=e.gatewayName,delete e.gatewayName,e.dispcallerid=e.dispCallerId,delete e.dispCallerId,e.termdescription=e.termDescription,delete e.termDescription,e.dispdestination=e.dispDestination,delete e.dispDestination,e}),l.send({status_code:200,message:"Customer CDR list.",data:e[0][0]}),o.apiInstance.log(200,"Customer CDR list.","getCustomerCDR","pbx",t.id,"")):s.page_per_size&&s.page_number?(l.send({status_code:416,message:"Range Not Satisfiable.",data:[]}),o.apiInstance.log(416,"Range Not Satisfiable.","getCustomerCDR","pbx",t.id,"")):(l.send({status_code:201,message:"No Data found.",data:[]}),o.apiInstance.log(201,"No Data found.","getCustomerCDR","pbx",t.id,""))}).catch(function(e){throw logger_util_1.errorLog(e),l.status(400).send({status_code:400,message:"Bad Request"}),o.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getCustomerCDR","pbx",t.id,""),e})):(this.apiInstance.log(403,"Forbidden - User has no permission for perform this action.","getMinutePlan","pbx","","",""),l.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for perform this action"}))},e.prototype.getAdminCDR=function(e,t,l){var s=this;"0"==(e.user_type||0)?((e=e.body).flag_limit=e.flag_limit?Number(e.flag_limit):0,knex.raw("Call pbx_getAdminCdrInfo("+e.flag_limit+")").then(function(e){e[0][0].length?(t.send({status_code:200,message:"Admin CDR list.",data:e[0][0]}),s.apiInstance.log(200,"Admin CDR list.","getAdminCDR","crm","")):(t.send({status_code:201,message:"No Data found.",data:[]}),s.apiInstance.log(201,"No Data found.","getAdminCDR","crm",""))}).catch(function(e){throw logger_util_1.errorLog(e),t.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getAdminCDR","crm",""),e})):(this.apiInstance.log(403,"Forbidden - User has no permission for perform this action.","getMinutePlan","crm","","",""),t.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for perform this action"}))},e.prototype.getCRMCDR=function(t,l,e){var s,a,n,i=this,o=t.user_type||1;t.app_type;console.log("request data",Object.values(t)),console.log("Extesion number get here",o),o==constant_1.UserTypeConstants.EXTENSION?(a=(s=t.body).missed_call?Number(s.missed_call):null,s.company=s.company?"'"+s.company+"'":null,s.sellcost=s.sellcost?"'"+s.sellcost+"'":null,s.caller=s.caller?"'"+s.caller+"'":null,s.callee=s.callee?"'"+s.callee+"'":null,s.callcost=s.callcost?"'"+s.callcost+"'":null,s.destination=s.destination?"'"+s.destination+"'":null,s.callerid=s.callerid?"'"+s.callerid+"'":null,s.uuid=s.uuid?"'"+s.uuid+"'":null,n=s.date_from?"'"+s.date_from+"'":null,o=s.date_to?"'"+s.date_to+"'":null,s.call_type=s.call_type?"'"+s.call_type+"'":null,s.terminatecause=a?"'486,480,487'":s.terminatecause&&s.terminatecause.length?"'"+s.terminatecause+"'":null,s.page_per_size=s.page_per_size?"'"+s.page_per_size+"'":null,s.page_number=s.page_number?"'"+s.page_number+"'":null,console.log(knex.raw("Call pbx_getExtensionCdrByFilters("+n+","+o+","+t.id+","+s.callcost+","+s.sellcost+","+s.caller+","+s.callee+","+s.destination+","+s.callerid+","+s.terminatecause+","+s.call_type+","+s.page_per_size+","+s.page_number+","+s.uuid+")").toString()),knex.raw("Call pbx_getExtensionCdrByFilters("+n+","+o+","+t.id+","+s.callcost+","+s.sellcost+","+s.caller+","+s.callee+","+s.destination+","+s.callerid+","+s.terminatecause+","+s.call_type+","+s.page_per_size+","+s.page_number+","+s.uuid+")").then(function(e){e[0][0].length?((e[0][0]||[]).map(function(e){return delete e.id,delete e.hangup_disposition,e.caller=e.src,delete e.src,e.date_from=e.startTime,e.date_to=e.endTime,delete e.startTime,delete e.endTime,delete e.buyCost,e.endpoint=e.dispDst,delete e.dispDst,e.sellcost=e.sellCost,delete e.sellCost,e.callcost=e.callCost,delete e.callCost,e.bridgetime=e.bridgeTime,delete e.bridgeTime,e.sessiontime=e.sessionTime,delete e.sessionTime,e.callplanname=e.callPlanName,delete e.callPlanName,e.gatewayname=e.gatewayName,delete e.gatewayName,e.dispcallerid=e.dispCallerId,delete e.dispCallerId,e.termdescription=e.termDescription,delete e.termDescription,e.dispdestination=e.dispDestination,delete e.dispDestination,e}),l.send({status_code:200,message:"Extension CDR list.",data:e[0][0]}),i.apiInstance.log(200,"Extension CDR list.","getCRMCDR","crm",t.customer_id,t.ext_number)):(l.send({status_code:201,message:"No Data found.",data:[]}),i.apiInstance.log(201,"No Data found.","getCRMCDR","crm",t.customer_id,t.ext_number))}).catch(function(e){throw logger_util_1.errorLog(e),l.status(400).send({status_code:400,message:"Bad Request"}),i.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getCRMCDR","crm",t.customer_id,t.ext_number),e})):(this.apiInstance.log(403,"Forbidden - User has no permission for perform this action.","getMinutePlan","pbx","","",""),l.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for perform this action"}))},e}();exports.CDRService=CDRService;