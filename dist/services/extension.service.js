"use strict";var __assign=this&&this.__assign||function(){return(__assign=Object.assign||function(e){for(var t,n=1,s=arguments.length;n<s;n++)for(var a in t=arguments[n])Object.prototype.hasOwnProperty.call(t,a)&&(e[a]=t[a]);return e}).apply(this,arguments)},__awaiter=this&&this.__awaiter||function(e,i,o,l){return new(o=o||Promise)(function(n,t){function s(e){try{r(l.next(e))}catch(e){t(e)}}function a(e){try{r(l.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?n(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(s,a)}r((l=l.apply(e,i||[])).next())})},__generator=this&&this.__generator||function(n,s){var a,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(a)throw new TypeError("Generator is already executing.");for(;o;)try{if(a=1,r&&(i=2&t[0]?r.return:t[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,t[1])).done)return i;switch(r=0,(t=i?[2&t[0],i.value]:t)[0]){case 0:case 1:i=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,r=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(i=0<(i=o.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){o.label=t[1];break}if(6===t[0]&&o.label<i[1]){o.label=i[1],i=t;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(t);break}i[2]&&o.ops.pop(),o.trys.pop();continue}t=s.call(n,o)}catch(e){t=[6,e],r=0}finally{a=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ExtensionService=void 0;var logger_util_1=require("../utils/logger.util"),table_1=require("../dba/table"),api_logs_1=require("../utils/api-logs"),validation_util_1=require("../utils/validation.util"),knex=require("../dba/knex.db"),axios=require("axios").default,ExtensionService=function(){function e(){this.apiInstance=new api_logs_1.ApiLogs,this.validationInstance=new validation_util_1.Validation}return e.prototype.getAllExtension=function(e,t,n){},e.prototype.getAllExtesnionContacts=function(e,t,n){var s=this,a=e.ext_number||0;knex.from(table_1.Table.tbl_Extension_Master+" as ext").select("ext.id").where("ext.ext_number","=",a).then(function(e){e.length?(e=e[0].id,knex.from(table_1.Table.tbl_Contact_List+" as c").select("name","email","phone_number1 as primary","phone_number2 as secondary","organization","designation").where("c.extension_id","=",e).then(function(e){t.json({status_code:200,message:"Contact list.",data:e}),s.apiInstance.log(200,"Contact list.","getAllExtesnionContacts","pbx","",a)}).catch(function(e){throw logger_util_1.errorLog(e),t.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request.","getAllExtesnionContacts","pbx","",a),e})):(t.status(401).send({error:"Unauthorized",message:"user does not exist"}),s.apiInstance.log(401,"User does not exist.","getAllExtesnionContacts","pbx","",a))})},e.prototype.getExtesnionCallHistory=function(e,t,n){var s=this,a=e.ext_number||0;knex.from(table_1.Table.tbl_Extension_Master+" as ext").select("ext.id").where("ext.ext_number","=",a).then(function(e){e.length?(e=e[0].id,knex.raw("Call pbx_getExtensionCdrInfo("+e+")").then(function(e){e&&(t.send({status_code:200,message:"Call History.",data:e[0][0]}),s.apiInstance.log(200,"Call History.","getExtesnionCallHistory","pbx","",a))}).catch(function(e){throw logger_util_1.errorLog(e),t.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request.","getExtesnionCallHistory","pbx","",a),e})):(t.status(401).send({error:"Unauthorized",message:"user does not exist"}),s.apiInstance.log(401,"User does not exist.","getExtesnionCallHistory","pbx","",a))})},e.prototype.saveExtesnionLocation=function(t,n,e){var s=this,a=parseInt(t.params.id);knex(table_1.Table.tbl_SoftPhone_Logs).insert({username:""+a,city:""+t.body.city,state:""+t.body.state,country:""+t.body.country,latitude:""+t.body.latitude,longitude:""+t.body.longitude}).then(function(e){0<e.length?(n.json({data:t.body,status_code:200,message:"You have uploaded location data."}),s.apiInstance.log(200,"Uploaded location data.","saveExtesnionLocation","pbx","",a)):(n.status(401).send({error:"Unauthorized",message:"Softphone location Creation error"}),s.apiInstance.log(401,"Softphone location Creation error.","saveExtesnionLocation","pbx","",a))}).catch(function(e){throw logger_util_1.errorLog(e),n.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request.","saveExtesnionLocation","pbx","",a),e})},e.prototype.makeExtensionContactAsFavorite=function(s,a,e){var r=this;if("6"==(s.user_type||1)){var i=s.body;if(!i.extension)return this.apiInstance.log(402,"Parameter Missing - extension.","makeExtensionContactAsFavorite","pbx","",s.ext_number,JSON.stringify(i)),a.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the extension"});knex.from(table_1.Table.tbl_Extension_Master).select(knex.raw("COUNT(id) as count")).where("ext_number",i.extension).andWhere("customer_id",s.customer_id).then(function(e){var n;console.log(e[0]),0==e[0].count?(r.apiInstance.log(403,"Forbidden - User has no permission for this extension.","makeExtensionContactAsFavorite","pbx","",s.ext_number,JSON.stringify(i)),a.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for this extension"})):(n=s.id||0,knex.from(table_1.Table.tbl_Extension_Master).select(knex.raw("COUNT(id) as count")).where("favorite","like","%"+i.extension+"%").andWhere("id",n).then(function(e){0==e[0].count?knex.raw('select *, json_extract(favorite,"$.ext_number") favorite from extension_master  where id ='+n).then(function(e){var t;e&&((t=e[0][0].favorite?e[0][0].favorite.replace(/"/g,"").split(","):[]).push(i.extension),(e={}).ext_number=t.toString(),console.log(knex.raw("Call pbx_save_extension_favorite_contact("+n+",'"+JSON.stringify(e)+"','make_favorite')").toString()),knex.raw("Call pbx_save_extension_favorite_contact("+n+",'"+JSON.stringify(e)+"','make_favorite')").then(function(e){e&&(a.send({status_code:200,message:"You have maked contact as favorite."}),r.apiInstance.log(200,"maked contact as favorite.","makeExtensionContactAsFavorite","pbx","",s.ext_number))}).catch(function(e){throw logger_util_1.errorLog(e),a.status(400).send({status_code:400,message:"Bad Request"}),r.apiInstance.log(400,"Bad Request.","makeExtensionContactAsFavorite","pbx","",s.ext_number,JSON.stringify(i)),e}))}).catch(function(e){throw logger_util_1.errorLog(e),a.status(400).send({status_code:400,message:"Bad Request"}),r.apiInstance.log(400,"Bad Request.","makeExtensionContactAsFavorite","pbx","",s.ext_number,JSON.stringify(i)),e}):(console.log("come in "),a.send({status_code:409,message:"Conflict : This contact already maked as a favorite"}),r.apiInstance.log(409,"Conflict : This contact already maked as a favorite.","makeExtensionContactAsFavorite","pbx","",s.ext_number,JSON.stringify(i)))}).catch(function(e){throw logger_util_1.errorLog(e),a.status(400).send({status_code:400,message:"Bad Request"}),e}))}).catch(function(e){throw logger_util_1.errorLog(e),a.status(400).send({status_code:400,message:"Bad Request"}),e})}else this.apiInstance.log(403,"Forbidden - User has no permission for perform this action.","makeExtensionContactAsFavorite","pbx","","",""),a.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for perform this action"})},e.prototype.getAllFavoriteExtesnionContact=function(e,n,t){var s,a,r,i,o,l=this,u=e.user_type||1;console.log(u,"hello"),"6"==u?(s=0,a=e.body.filters,r=e.ext_number||0,i=e.customer_id||0,(o=knex.from(table_1.Table.tbl_Extension_Master).select("ext_number as extension","username","mobile","email").where("status","=","1")).orderBy("ext_number","desc"),""!=a.by_username&&a.hasOwnProperty("by_username")&&(o=o.andWhere("username","like","%"+a.by_username+"%")),""!=a.by_roaming&&a.hasOwnProperty("by_roaming")&&(o=o.andWhere("roaming","=",a.by_roaming)),""!=i&&(o=o.andWhere("customer_id","like","%"+i+"%")),""!=a.by_number&&a.hasOwnProperty("by_number")&&(o=o.andWhere("ext_number","like","%"+a.by_number+"%")),""!=a.by_type&&a.hasOwnProperty("by_type")&&knex.raw("select JSON_UNQUOTE(json_extract(favorite,'$.ext_number')) fav from extension_master where customer_id ="+i+" and ext_number="+r).then(function(e){var t;console.log("response[0][0]['fav']",e[0][0].fav),!e[0][0].fav||"favorite"!=a.by_type&&"unfavorite"!=a.by_type?e[0][0].fav||"favorite"!=a.by_type?(s++,(t=knex.from(table_1.Table.tbl_Extension_Master).select("ext_number as extension","username","mobile","email").where("status","=","1").andWhere("customer_id","like","%"+i+"%")).orderBy("ext_number","desc"),t=t.whereNotIn("ext_number",r.split(" ")),console.log(t.toQuery()),t.then(function(e){e?(n.json({status_code:200,message:"Extension Info.",data:e}),l.apiInstance.log(200,"Extension Info.","getAllFavoriteExtesnionContact","pbx","",r,JSON.stringify(a))):(n.status(401).send({error:"error",message:"DB Error: Unable to get data"}),l.apiInstance.log(401,"Unable to get data.","getAllFavoriteExtesnionContact","pbx","",r,JSON.stringify(a)))}).catch(function(e){throw console.log(e),n.status(401).send({error:"error",message:"DB Error: "+e.message}),l.apiInstance.log(400,"Bad Request.","getAllFavoriteExtesnionContact","pbx","",r,JSON.stringify(a)),e})):(n.status(201).send({status_code:201,message:"No Data found : User has no favorite contact",data:[]}),l.apiInstance.log(201,"No Data found : User has no favorite contact.","getAllFavoriteExtesnionContact","pbx","",r,JSON.stringify(a))):(e=e[0][0].fav?e[0][0].fav.split(","):"")||"favorite"!=a.by_type?(s++,o="favorite"==a.by_type?o.whereIn("ext_number",e):o.whereNotIn("ext_number",e),console.log(o.toQuery()),o.then(function(e){e?(n.json({status_code:200,message:"Extension Info.",data:e}),l.apiInstance.log(200,"Extension Info.","getAllFavoriteExtesnionContact","pbx","",r)):(n.status(401).send({error:"error",message:"DB Error: Unable to get data"}),l.apiInstance.log(401,"Unable to get data.","getAllFavoriteExtesnionContact","pbx","",r,JSON.stringify(a)))}).catch(function(e){throw logger_util_1.errorLog(e),n.status(400).send({status_code:400,message:"Bad Request"}),l.apiInstance.log(400,"Bad Request.","getAllFavoriteExtesnionContact","pbx","",r,JSON.stringify(a)),e})):(n.status(401).send({error:"error",message:"User has no favorite/unfavorite contact"}),l.apiInstance.log(401,"User has no favorite/unfavorite contact.","getAllFavoriteExtesnionContact","pbx","",r,JSON.stringify(a)))}).catch(function(e){throw logger_util_1.errorLog(e),n.status(400).send({status_code:400,message:"Bad Request: "+e.sqlMessage}),l.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getAllFavoriteExtesnionContact","pbx","",r,JSON.stringify(a)),e}),0<s&&o.then(function(e){e?n.json({response:e}):(n.status(401).send({error:"error",message:"DB Error: Unable to get data"}),l.apiInstance.log(401,"Unable to get data.","getAllFavoriteExtesnionContact","pbx","",r))}).catch(function(e){throw logger_util_1.errorLog(e),n.status(400).send({status_code:400,message:"Bad Request"}),l.apiInstance.log(400,"Bad Request.","getAllFavoriteExtesnionContact","pbx","",r,JSON.stringify(a)),e})):(this.apiInstance.log(403,"Forbidden - User has no permission for perform this action.","getAllFavoriteExtesnionContact","pbx","","",""),n.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for perform this action"}))},e.prototype.makeExtensionContactAsUnFavorite=function(s,a,e){var r=this,i=s.body;if(!i.extension)return this.apiInstance.log(402,"Parameter Missing - extension.","gatewayLogin","pbx","",s.ext_number),a.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the extension"});knex.from(table_1.Table.tbl_Extension_Master).select(knex.raw("COUNT(id) as count")).where("ext_number",i.extension).andWhere("customer_id",s.customer_id).then(function(e){var n;0==e[0].count?(a.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for this extension"}),r.apiInstance.log(403,"Forbidden - User has no permission for this extension.","makeExtensionContactAsUnFavorite","pbx","",s.ext_number,JSON.stringify(i))):(n=s.id||0,knex.from(table_1.Table.tbl_Extension_Master).select(knex.raw("COUNT(id) as count")).where("favorite","like","%"+i.extension+"%").andWhere("id",n).then(function(e){0==e[0].count?(a.send({status_code:409,message:"Conflict : This contact already maked as a Un-favorite"}),r.apiInstance.log(409,"Conflict : This contact already maked as a Un-favorite.","makeExtensionContactAsUnFavorite","pbx","",s.ext_number,JSON.stringify(i))):knex.raw('select *, json_extract(favorite,"$.ext_number") favorite from extension_master  where id ='+n).then(function(e){var t;e&&(t=(t=e[0][0].favorite?e[0][0].favorite.replace(/"/g,"").split(","):[]).filter(function(e){return e!=i.extension}),(e={}).ext_number=t.toString(),console.log(knex.raw("Call pbx_save_extension_favorite_contact("+n+",'"+JSON.stringify(e)+"','make_unfavorite')").toString()),knex.raw("Call pbx_save_extension_favorite_contact("+n+",'"+JSON.stringify(e)+"','make_unfavorite')").then(function(e){e&&(a.send({status_code:200,message:"You have maked contact as un-favorite."}),r.apiInstance.log(200,"You have maked contact as un-favorite.","makeExtensionContactAsUnFavorite","pbx","",s.ext_number))}).catch(function(e){throw logger_util_1.errorLog(e),a.status(400).send({status_code:400,message:"Bad Request"}),r.apiInstance.log(400,"Bad Request.","makeExtensionContactAsUnFavorite","pbx","",s.ext_number,JSON.stringify(i)),e}))}).catch(function(e){throw logger_util_1.errorLog(e),a.status(400).send({status_code:400,message:"Bad Request"}),r.apiInstance.log(400,"Bad Request.","makeExtensionContactAsUnFavorite","pbx","",s.ext_number,JSON.stringify(i)),e})}).catch(function(e){throw logger_util_1.errorLog(e),a.status(400).send({status_code:400,message:"Bad Request"}),r.apiInstance.log(400,"Bad Request.","makeExtensionContactAsUnFavorite","pbx","",s.ext_number,JSON.stringify(i)),e}))}).catch(function(e){throw logger_util_1.errorLog(e),a.status(400).send({status_code:400,message:"Bad Request"}),r.apiInstance.log(400,"Bad Request.","makeExtensionContactAsUnFavorite","pbx","",s.ext_number,JSON.stringify(i)),e})},e.prototype.getExtesnionProfie=function(e,t,n){var s=this,a=e.ext_number||0,r=(r=e.headers.host).replace("3001","3000");knex.from(table_1.Table.tbl_Extension_Master+" as ext").select("ext.ext_number as extension","ext.caller_id_name as callername","ext.email","ext.mobile","ext.username","ext.profile_img").where("ext.ext_number","=",a).then(function(e){e.length?((e||[]).map(function(e){return e.profile_img=e.profile_img?r+e.profile_img:"",e}),t.json({status_code:200,message:"User profile Info.",data:e}),s.apiInstance.log(200,"User profile Info.","getExtesnionProfie","pbx","",a)):(t.status(401).send({error:"Unauthorized",message:"user does not exist"}),s.apiInstance.log(401,"user does not exist.","getExtesnionProfie","pbx","","",a))}).catch(function(e){throw logger_util_1.errorLog(e),t.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getExtesnionProfie","pbx","","",a),e})},e.prototype.getExtesnionProfieForSP=function(e,t,n){var s=this,a=e.ext_number||0,r=(r=e.headers.host).replace("3001","3000");knex.from(table_1.Table.tbl_Extension_Master+" as ext").select("ext.ext_number as extension","ext.caller_id_name as callername","ext.email","ext.mobile","ext.username","ext.profile_img").where("ext.ext_number","=",a).then(function(e){e.length?((e||[]).map(function(e){return e.profile_img=e.profile_img?r+e.profile_img:"",e}),t.json({status_code:200,message:"User profile Info.",data:e}),s.apiInstance.log(200,"User profile Info.","getExtesnionProfie","sp","",a)):(t.status(401).send({error:"Unauthorized",message:"user does not exist"}),s.apiInstance.log(401,"user does not exist.","getExtesnionProfie","sp","","",a))}).catch(function(e){throw logger_util_1.errorLog(e),t.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getExtesnionProfie","sp","","",a),e})},e.prototype.getIndividualExtesnionInfo=function(t,n,e){var s=this,a=t.body,r=a.extension;if(!a.extension)return this.apiInstance.log(402,"Parameter Missing - extension.","getIndividualExtesnionInfo","pbx","",t.ext_number,JSON.stringify(a)),n.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the extension"});knex.from(table_1.Table.tbl_Extension_Master).select(knex.raw("COUNT(id) as count")).where("ext_number",a.extension).andWhere("customer_id",t.customer_id).then(function(e){0==e[0].count?(s.apiInstance.log(403,"Forbidden - User has no permission for this extension.","getIndividualExtesnionInfo","pbx","",t.ext_number,JSON.stringify(a)),n.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for this extension"})):knex.from(table_1.Table.tbl_Extension_Master+" as ext").select("ext.ext_number as extension","ext.caller_id_name as callername","ext.email","ext.mobile","ext.username").where("ext.ext_number","=",r).then(function(e){e.length?(s.apiInstance.log(200,"Extension Info.","getIndividualExtesnionInfo","pbx","",t.ext_number),n.json({status_code:200,message:"Extension Info.",data:e})):(n.status(401).send({error:"Unauthorized",message:"extension does not exist"}),s.apiInstance.log(401,"user does not exist.","getIndividualExtesnionInfo","pbx","",t.ext_number,JSON.stringify(a)))}).catch(function(e){throw logger_util_1.errorLog(e),n.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request.","getIndividualExtesnionInfo","pbx","",t.ext_number,JSON.stringify(a)),e})}).catch(function(e){throw logger_util_1.errorLog(e),n.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request.","getIndividualExtesnionInfo","pbx","",t.ext_number,JSON.stringify(a)),e})},e.prototype.updateExtensionProfile=function(r,i,o,l){return __awaiter(this,void 0,void 0,function(){var t,n,s,a=this;return __generator(this,function(e){switch(e.label){case 0:return(t=r.ext_number||0,(n=r.body)&&0===Object.keys(n).length&&n.constructor===Object&&(this.apiInstance.log(402,"Parameter Missing For update.","updateExtensionProfile",l,"",t),i.status(402).send({error:"parameter Missing",message:"Please provide data which you want to update"})),s={},r.body.username&&(s.username=r.body.username),r.body.email)?(s.email=r.body.email,[4,this.validationInstance.validateEmail(s.email)]):[3,2];case 1:e.sent()||(this.apiInstance.log(402,"Wrong Email Id.","updateExtensionProfile",l,"",t,JSON.stringify(n)),i.status(402).send({error:"Wrong Email Id",message:"Please provide the correct email id."})),e.label=2;case 2:return r.body.mobile?(s.mobile=r.body.mobile,[4,this.validationInstance.validateMobile(s.mobile)]):[3,4];case 3:e.sent()||(this.apiInstance.log(402,"Wrong Mobile Number.","updateExtensionProfile",l,"",t,JSON.stringify(n)),i.status(402).send({error:"Wrong Mobile Number",message:"Please provide the correct mobile number."})),e.label=4;case 4:return r.body.callername&&(s.caller_id_name=r.body.callername),r.body.email?knex(table_1.Table.tbl_Extension_Master).select(knex.raw("COUNT(id) as count")).where("email",r.body.email).whereNot("ext_number",t).then(function(e){console.log(e,"<==========,update profile data here"),0<e[0].count?(i.status(403).send({status_code:403,error:"Forbidden",message:"Email id already exists"}),a.apiInstance.log(403,"Forbidden - Email id already exists.","updateExtensionProfile",l,"",t,JSON.stringify(n))):a.updateProfile(r,i,o,l,s,t,n)}).catch(function(e){throw logger_util_1.errorLog(e),i.status(400).send({status_code:400,message:"Bad Request"}),a.apiInstance.log(400,"Bad Request.","updateExtensionProfile",l,"",t,JSON.stringify(n)),e}):this.updateProfile(r,i,o,l,s,t,n),[2]}})})},e.prototype.updateProfile=function(e,t,n,s,a,r,i){var o=this;knex(table_1.Table.tbl_Extension_Master).update(a).where("ext_number",r).then(function(e){console.log(e),e?(t.json({status_code:200,message:"Profile has been updated."}),o.apiInstance.log(200,"Profile has been updated.","updateExtensionProfile",s,"",r)):(t.status(402).send({message:"Profile Updation error!"}),o.apiInstance.log(402,"Profile Updation error!.","updateExtensionProfile",s,"",r,JSON.stringify(i)))}).catch(function(e){throw logger_util_1.errorLog(e),t.status(400).send({status_code:400,message:"Bad Request"}),o.apiInstance.log(400,"Bad Request.","updateExtensionProfile","pbx","",r,JSON.stringify(i)),e})},e.prototype.getAllUserExtensions=function(e,t,n){var s=this,a=e.customer_id||0;knex.from(table_1.Table.tbl_Extension_Master+" as ext").select("ext.id","ext.ext_number as extension","ext.caller_id_name as callername","ext.email","ext.mobile","ext.username",knex.raw('IF(extloc.username != "","Register","Un-Register") as status')).leftJoin(table_1.Table.tbl_Register_Extension_Location+" as extloc","extloc.username","ext.ext_number").where("ext.customer_id","=",a).then(function(e){e.length?((e||[]).map(function(e){return delete e.id,e}),t.json({status_code:200,message:"Extension listing.",data:e}),s.apiInstance.log(200,"Extension listing..","getAllUserExtensions","pbx",a)):(t.status(201).send({status_code:201,message:"No Data found"}),s.apiInstance.log(201,"No Data found.","getAllUserExtensions","pbx",a))})},e.prototype.getExtensionsDIDmapping=function(t,n,e){var s=this,a=t.ext_number||0,r=t.customer_id||0;a&&(this.apiInstance.log(403,"Forbidden - User has no permission for this action.","getExtensionsDIDmapping","pbx",r),n.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for this action"})),knex.select("pro.provider","c.name as country","d.reserved","d.customer_id","cust.first_name as customer_name","d.did",knex.raw("CONCAT((CONCAT(\"+\",c.phonecode)), ' ',d.did) as didDisplay"),"d.secondusedreal",knex.raw('IF (d.billingtype = "1","Fix per month + Dialoutrate", IF (d.billingtype = "2","Fix per month", IF (d.billingtype = "3","Only dialout rate","Free"))) as billingtype'),"d.fixrate","d.connection_charge","d.selling_rate","d.max_concurrent","d.did_type",knex.raw('IF (d.did_type = "1","DID Number", IF (d.did_type = "2","DID Number","Tollfree Number")) as did_type'),knex.raw('IF (d.did_group = "0","General", IF (d.did_group = "1","Premium", IF (d.did_group = "2","Private","Parked"))) as did_group'),knex.raw('IF (d.activated = "0","Inactive","Active") as activated'),knex.raw('IF (d.status = "0","Inactive", IF (d.status = "1","Active","Deleted")) as status'),"af.active_feature","time.name as time_group_name",knex.raw('IF (dest.active_feature_id = "1",ext.ext_number, IF (dest.active_feature_id = "2",ivr.name, IF (dest.active_feature_id = "3",conf.name,IF (dest.active_feature_id = "4",que.name,IF (dest.active_feature_id = "5",call.name,IF (dest.active_feature_id = "10",tc.name,IF (dest.active_feature_id = "11",bc.name,IF (dest.active_feature_id = "12",pr.prompt_name,IF (dest.active_feature_id = "13",appointment.name, ""))))))))) as destination_name')).from(table_1.Table.tbl_DID+" as d").leftJoin(table_1.Table.tbl_Provider+" as pro","pro.id","d.provider_id").leftJoin(table_1.Table.tbl_Country+" as c","c.id","d.country_id").leftJoin(table_1.Table.tbl_DID_Destination+" as dest","d.id","dest.did_id").leftJoin(table_1.Table.tbl_DID_active_feature+" as af","dest.active_feature_id","af.id").leftJoin(table_1.Table.tbl_Extension_Master+" as ext","dest.destination_id","ext.id").leftJoin(table_1.Table.tbl_Ivr_Master+" as ivr","dest.destination_id","ivr.id").leftJoin(table_1.Table.tbl_Conference+" as conf","dest.destination_id","conf.id").leftJoin(table_1.Table.tbl_Queue+" as que","dest.destination_id","que.id").leftJoin(table_1.Table.tbl_CALLGROUP+" as call","dest.destination_id","call.id").leftJoin(table_1.Table.tbl_Time_Group+" as time","dest.time_group_id","time.id").leftJoin(table_1.Table.tbl_TC+" as tc","dest.destination_id","tc.id").leftJoin(table_1.Table.tbl_Broadcast+" as bc","dest.destination_id","bc.id").leftJoin(table_1.Table.tbl_Prompt+" as pr","dest.destination_id","pr.id").leftJoin(table_1.Table.tbl_Appointment+" as appointment","dest.destination_id","appointment.id").leftJoin(table_1.Table.tbl_Customer+" as cust","cust.id","d.customer_id").where("d.status","!=","2").andWhere("d.customer_id","=",""+r).orderBy("d.id","desc").then(function(e){e&&(n.json({status_code:200,message:"DID Mapping.",data:e}),s.apiInstance.log(200,"DID Mapping.","getExtensionsDIDmapping","pbx",r,t.ext_number))}).catch(function(e){throw console.log(e),n.status(401).send({error:"error",message:"DB Error: "+e.message}),s.apiInstance.log(400,"Bad Request.","getExtensionsDIDmapping","pbx",r,t.ext_number),e})},e.prototype.getExtensionCall2Call=function(l,u,e){return __awaiter(this,void 0,void 0,function(){var t,n,s,a,r,i,o;return __generator(this,function(e){switch(e.label){case 0:return t=l.body,n="1111",s=l.ext_number||0,a=l.customer_id||0,t.destination_number?[4,knex.select("c.*").from(table_1.Table.tbl_Customer+" as c").andWhere("c.id",a).andWhere("c.role_id","1").then(function(e){return e?e[0].callback_url:"no"})]:(this.apiInstance.log(402,"Parameter Missing - username.","getExtensionC2C","pbx","",l.ext_number,JSON.stringify(t)),[2,u.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the username"})]);case 1:return r=e.sent(),i=(i=l.hostname).split(":")[0],i="http://127.0.0.1:"+n+"/esl_api",(o={application:"click2call"}).cust_id=a,o.extension=s,o.destination_number=t.destination_number,o.callback_url=r||"no",console.log("baseUrl",i),console.log("obj",o),axios.post(i,o).then(function(e){u.send({status_code:200,message:"C2C Status.",data:e.data}),(new api_logs_1.ApiLogs).log(200,"C2C Status : "+(e.data?e.data.data:""),"getExtensionC2C","pbx","",l.ext_number)}).catch(function(e){u.send({status_code:400,message:"C2C Status.",data:e}),this.apiInstance.log(400,"Bad Request : "+e.sqlMessage,"getExtensionC2C","pbx","",l.ext_number,JSON.stringify(t))}),[2]}})})},e.prototype.getC2Cstatus=function(t,n,e){var s=this,a=t.body,r=a.uuid;if(!a.uuid)return this.apiInstance.log(402,"Parameter Missing - uuid.","getC2Cstatus","pbx","",t.ext_number,JSON.stringify(a)),n.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the uuid"});knex.from(table_1.Table.tbl_Realtime_CDR+" as r").select("r.uuid","r.destination","r.current_status","r.src","r.call_disposition").where("r.uuid","=",r).then(function(e){e?0!=e.length?(n.json({status_code:200,message:"c2c current status.",data:e}),s.apiInstance.log(200,"C2C current Status.","getC2Cstatus","pbx","",t.ext_number)):(n.status(201).send({status_code:402,message:"Please provide valid uuid."}),s.apiInstance.log(402,"No current Status.","getC2Cstatus","pbx","",t.ext_number,JSON.stringify(a))):(n.status(201).send({status_code:201,message:"No Data found"}),s.apiInstance.log(201,"No current Status.","getC2Cstatus","pbx","",t.ext_number,JSON.stringify(a)))})},e.prototype.getCRMExtensionCall2Call=function(t,n,e){var s=t.body;if(!s.destination_number)return this.apiInstance.log(402,"Parameter Missing - username.","getcrmExtensionC2C","crm","",t.ext_number,JSON.stringify(s)),n.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the username"});if("number"!=typeof s.destination_number)return this.apiInstance.log(402,"Invalid Parameter - username.","getcrmExtensionC2C","crm","",t.ext_number,JSON.stringify(s)),n.status(402).send({status_code:402,error:"Invalid Paramter.",message:"Please enter the valid destination number."});if(!s.callback_url)return this.apiInstance.log(402,"Parameter Missing - callback url.","getcrmExtensionC2C","crm","",t.ext_number,JSON.stringify(s)),n.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the callback url"});if(!s.token)return this.apiInstance.log(402,"Parameter Missing - token.","getcrmExtensionC2C","crm","",t.ext_number,JSON.stringify(s)),n.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the token"});var a=t.ext_number||0,r=t.customer_id||0,i=t.hostname;i="http://"+(i=i.split(":")[0])+":1111/esl_api";var o={application:"click2call"};o.cust_id=r,o.extension=a,o.destination_number=s.destination_number,o.callback_url=s.callback_url||"no",o.token_id=s.token,console.log("baseUrl",i),console.log("obj",o),axios.post(i,o).then(function(e){n.send({status_code:200,message:"C2C Status.",data:e.data}),(new api_logs_1.ApiLogs).log(200,"C2C Status : "+(e.data?e.data.data:""),"getcrmExtensionC2C","crm","",t.ext_number)}).catch(function(e){n.send({status_code:400,message:"C2C Status.",data:e}),this.apiInstance.log(400,"Bad Request : "+e.sqlMessage,"getcrmExtensionC2C","crm","",t.ext_number,JSON.stringify(s))})},e.prototype.getCRMC2Cstatus=function(t,n,e){var s=this,a=t.body,r=a.uuid;if(!a.uuid)return this.apiInstance.log(402,"Parameter Missing - uuid.","getCrmC2Cstatus","crm","",t.ext_number,JSON.stringify(a)),n.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the uuid"});knex.from(table_1.Table.tbl_Realtime_CDR+" as r").select("r.uuid","r.destination","r.current_status","r.src","r.call_disposition").where("r.uuid","=",r).then(function(e){e?0!=e.length?(n.json({status_code:200,message:"c2c current status.",data:e}),s.apiInstance.log(200,"C2C current Status.","getC2Cstatus","crm","",t.ext_number)):(n.status(201).send({status_code:402,message:"Please provide valid uuid."}),s.apiInstance.log(402,"No current Status.","getC2Cstatus","crm","",t.ext_number,JSON.stringify(a))):(n.status(201).send({status_code:201,message:"No Data found"}),s.apiInstance.log(201,"No current Status.","getC2Cstatus","pbx","",t.ext_number,JSON.stringify(a)))})},e.prototype.extensionCreation=function(d,c,e){return __awaiter(this,void 0,void 0,function(){var r,t,i,o,l,u,n=this;return __generator(this,function(e){switch(e.label){case 0:return(r=d.body).extnumber?"number"!=typeof r.extnumber?(this.apiInstance.log(402,"Parameter type format - extnumber should be number.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Parameter type format",message:"extnumber should be number."})]):r.extnumber?[4,this.validationInstance.validateExtensionLength(d.customer_id)]:[3,3]:(this.apiInstance.log(402,"Parameter Missing - extnumber.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the extnumber"})]);case 1:return 4==(t=e.sent()).extension_length_limit&&4!=r.extnumber.toString().length&&3!=r.extnumber.toString().length&&2!=r.extnumber.toString().length?(this.apiInstance.log(402,"Parameter - extnumber length .","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Extension length limit exceed",message:"Please enter valid digit length of extnumber for 4"})]):3==t.extension_length_limit&&3!=r.extnumber.toString().length&&2!=r.extnumber.toString().length?(this.apiInstance.log(402,"Parameter - extnumber length .","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Extension length limit exceed",message:"Please enter valid digit length of extnumber for 3"})]):2!=t.extension_length_limit||4!=r.extnumber.toString().length&&3!=r.extnumber.toString().length&&2==r.extnumber.toString().length?[4,this.validationInstance.validateExtension(d.customer_id+""+r.extnumber,d.customer_id)]:(this.apiInstance.log(402,"Parameter - extnumber length .","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Extension length limit exceed",message:"Please enter valid digit length of extnumber for 2"})]);case 2:if(e.sent())return this.apiInstance.log(402,"Extension already in used.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({error:"Extension already in used",message:"Please provide the alternate extension number."})];e.label=3;case 3:return r.extname?r.email?r.email?[4,this.validationInstance.validateEmailExist(r.email)]:[3,6]:(this.apiInstance.log(402,"Parameter Missing - email.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the email"})]):(this.apiInstance.log(402,"Parameter Missing - extname.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the extname"})]);case 4:return e.sent()?(this.apiInstance.log(402,"Email already exist.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({error:"Email already exist",message:"Please provide the alternate email."})]):[4,this.validationInstance.validateEmail(r.email)];case 5:if(!e.sent())return this.apiInstance.log(402,"Provide Valid email.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Invalid Email",message:"Provide Valid email."})];e.label=6;case 6:return r.countryid?r.mobile?r.mobile?[4,this.validationInstance.validateMobile(r.mobile)]:[3,8]:(this.apiInstance.log(402,"Parameter Missing - mobile.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the mobile"})]):(this.apiInstance.log(402,"Parameter Missing - countrycode.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the countryid"})]);case 7:if(!e.sent())return this.apiInstance.log(402,"Wrong Mobile Number.","extensioncreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({error:"Wrong Mobile Number",message:"Please provide the correct mobile number."})];e.label=8;case 8:return r.calleridname?r.dtmftype?r.calleridheader?r.admin&&0!==r.admin&&1!==r.admin?(this.apiInstance.log(402,"Parameter admin should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"admin should be either 1 or 0"})]):r.balancerestriction&&0!==r.balancerestriction&&1!==r.balancerestriction?(this.apiInstance.log(402,"Parameter balancerestriction should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"balancerestriction should be either 1 or 0"})]):r.calltransfer&&0!==r.calltransfer&&1!==r.calltransfer?(this.apiInstance.log(402,"Parameter calltransfer should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"calltransfer should be either 1 or 0"})]):r.callforward&&0!==r.callforward&&1!==r.callforward?(this.apiInstance.log(402,"Parameter callforward should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"callforward should be either 1 or 0"})]):r.dialout&&0!==r.dialout&&1!==r.dialout?(this.apiInstance.log(402,"Parameter dialout should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"dialout should be either 1 or 0"})]):r.findmefollowme&&0!==r.findmefollowme&&1!==r.findmefollowme?(this.apiInstance.log(402,"Parameter findmefollowme should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"findmefollowme should be either 1 or 0"})]):r.multiplereg&&0!==r.multiplereg&&1!==r.multiplereg?(this.apiInstance.log(402,"Parameter multiplereg should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"multiplereg should be either 1 or 0"})]):r.misscallalert&&0!==r.misscallalert&&1!==r.misscallalert?(this.apiInstance.log(402,"Parameter misscallalert should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"misscallalert should be either 1 or 0"})]):r.outboundsmsnotification&&0!==r.outboundsmsnotification&&1!==r.outboundsmsnotification?(this.apiInstance.log(402,"Parameter outboundsmsnotification should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"outboundsmsnotification should be either 1 or 0"})]):r.recording&&0!==r.recording&&1!==r.recording?(this.apiInstance.log(402,"Parameter recording should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"recording should be either 1 or 0"})]):r.speeddial&&0!==r.speeddial&&1!==r.speeddial?(this.apiInstance.log(402,"Parameter speeddial should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"speeddial should be either 1 or 0"})]):r.stickyagent&&0!==r.stickyagent&&1!==r.stickyagent?(this.apiInstance.log(402,"Parameter stickyagent should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"stickyagent should be either 1 or 0"})]):r.outbound&&0!==r.outbound&&1!==r.outbound?(this.apiInstance.log(402,"Parameter outbound should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"outbound should be either 1 or 0"})]):r.ringtone&&0!==r.ringtone&&1!==r.ringtone?(this.apiInstance.log(402,"Parameter ringtone should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"ringtone should be either 1 or 0"})]):r.dtmftype&&0!==r.dtmftype&&1!==r.dtmftype?(this.apiInstance.log(402,"Parameter dtmftype should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"dtmftype should be either 1 or 0"})]):r.voicemail&&0!==r.voicemail&&1!==r.voicemail?(this.apiInstance.log(402,"Parameter voicemail should be either 1 or 0","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Only Number Allowed !",message:"voicemail should be either 1 or 0"})]):(i=d.user_type||"0",o=this.validationInstance.secure_password_generator(8),l=this.validationInstance.sipPassword(),u="",knex.select("pf.billing_type","pf.minute_balance","mcp.package_id","p.feature_id","pf.extension_limit","pf.recording","pf.is_caller_id","pf.outbound_call","pf.voicemail","pf.forward","pf.speed_dial","pf.black_list","pf.call_transfer","mcp.customer_id","pf.is_sms as sms","pf.miss_call_alert","pf.geo_tracking","pf.is_roaming_type as roaming","pf.find_me_follow_me","pf.custom_prompt","pf.sticky_agent","p.id as package_id").from(table_1.Table.tbl_Map_Customer_Package+" as mcp").leftJoin(table_1.Table.tbl_Package+" as p","p.id","mcp.package_id").leftJoin(table_1.Table.tbl_Features+" as pf","p.feature_id","pf.id").where("mcp.customer_id","=",""+d.customer_id).andWhere("mcp.product_id","=","1").then(function(a){return __awaiter(n,void 0,void 0,function(){var t,n,s=this;return __generator(this,function(e){switch(e.label){case 0:return t=a[0],console.log(t),[4,this.validationInstance.validateExtensionLimit(t.extension_limit,d.customer_id)];case 1:return e.sent()?(this.apiInstance.log(402,"Maximum extenstion limit exceeded.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({error:"Maximum extenstion limit exceeded",message:"Your Maximum extenstion limit has been exceeded."})]):("1"==i?((n=d.body).admin=1==n.admin?1:(n.admin,0),n.balancerestriction=1==n.balancerestriction?1:(n.balancerestriction,0),n.calltransfer=t.call_transfer?1==n.calltransfer?1:(n.calltransfer,0):0,n.callforward=t.forward?1==n.callforward?1:(n.callforward,0):0,n.dialout=t.outbound_call?1==n.dialout?1:(n.dialout,0):0,n.dnd=1==n.dnd?1:(n.dnd,0),n.findmefollowme=t.find_me_follow_me?1==n.findmefollowme?1:(n.findmefollowme,0):0,n.multiplereg=1==n.multiplereg?1:(n.multiplereg,0),n.misscallalert=t.miss_call_alert?1==n.misscallalert?1:(n.misscallalert,0):0,n.outboundsmsnotification=t.sms?1==n.outboundsmsnotification?1:(n.outboundsmsnotification,0):0,n.recording=t.recording?1==n.recording?1:(n.recording,0):0,n.roaming=t.roaming?1==n.roaming?1:(n.roaming,0):0,n.speeddial=t.speed_dial?1==n.speeddial?1:(n.speeddial,0):0,n.stickyagent=t.sticky_agent?1==n.stickyagent?1:(n.stickyagent,0):0,n.outbound=t.outbound_call?1==n.outbound?1:(n.outbound,0):0,n.ringtone=t.custom_prompt?1==n.ringtone?1:(n.ringtone,0):0,n.dtmftype=1==n.dtmftype?1:(n.dtmftype,0),n.voicemail=1==n.voicemail?1:(n.voicemail,0),n.voicemail&&(u=this.validationInstance.secure_password_generator(8)),n.headertype=0,n.callerIDheadervalue=0,knex(table_1.Table.tbl_Extension_Master).insert({package_id:t.package_id,customer_id:t.customer_id,ext_number:t.customer_id+""+r.extnumber,username:""+n.extname,password:""+o,email:""+n.email,send_misscall_notification:""+n.misscallalert,balance_restriction:""+n.balancerestriction,caller_id_name:""+n.calleridname,sip_password:""+l,ring_time_out:"60",dial_time_out:"60",external_caller_id:"",dtmf_type:""+n.dtmftype,caller_id_header_type:""+n.headertype,caller_id_header_value:""+n.callerIDheadervalue,multiple_registration:""+n.multiplereg,codec:"",voicemail:""+n.voicemail,dnd:""+n.dnd,vm_password:u,outbound:""+n.outbound,recording:""+n.recording,forward:""+n.callforward,speed_dial:""+n.speeddial,black_list:0,call_transfer:""+n.calltransfer,billing_type:t.billing_type,total_min_bal:0,token:n.token,api_token:"0",roaming:""+n.roaming,outbound_sms_notification:""+n.outboundsmsnotification,dial_prefix:""+n.countryid,mobile:""+n.mobile,admin:""+n.admin,find_me_follow_me:""+n.findmefollowme,ringtone:""+n.ringtone,sticky_agent:""+n.stickyagent}).then(function(e){s.apiInstance.log(200,"Extension created succesfully","extensionCreation","pbx","",d.ext_number,""),c.send({status_code:200,message:"Extension created succesfully.",web_password:o,extnumber:d.customer_id+""+r.extnumber,sip_password:l})}).catch(function(e){throw logger_util_1.errorLog(e),c.status(400).send({status_code:400,message:"Bad Request :"+e}),s.apiInstance.log(400,"Bad Request : "+e,"extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),e})):(this.apiInstance.log(403,"Forbidden - User has no permission for perform this action.","extensionCreation","pbx","","",""),c.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for perform this action"})),[2])}})})}),[2]):(this.apiInstance.log(402,"Parameter Missing - calleridheader.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the calleridheader"})]):(this.apiInstance.log(402,"Parameter Missing - dtmftype.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the dtmftype"})]):(this.apiInstance.log(402,"Parameter Missing - calleridname.","extensionCreation","pbx","",d.ext_number,JSON.stringify(r)),[2,c.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the calleridname"})])}})})},e.prototype.updateExtensionFeatures=function(t,n,e){var s=this,a=t.body,r=__assign({},a),i={},o=t.user_type||"0",l=t.query.ext_number;if(console.log("ext_number",l),!l)return this.apiInstance.log(402,"Parameter Missing - ext_number in params","updateExtensionFeatures","pbx","","",JSON.stringify(r)),n.status(402).send({status_code:402,error:"Parameter Missing",message:"Please pass ext_number in params"});knex.select("pf.billing_type","pf.minute_balance","mcp.package_id","p.feature_id","pf.extension_limit","pf.recording","pf.is_caller_id","pf.outbound_call","pf.voicemail","pf.forward","pf.speed_dial","pf.black_list","pf.call_transfer","mcp.customer_id","pf.is_sms as sms","pf.miss_call_alert","pf.geo_tracking","pf.is_roaming_type as roaming","pf.find_me_follow_me","pf.custom_prompt","pf.sticky_agent","p.id as package_id").from(table_1.Table.tbl_Map_Customer_Package+" as mcp").leftJoin(table_1.Table.tbl_Package+" as p","p.id","mcp.package_id").leftJoin(table_1.Table.tbl_Features+" as pf","p.feature_id","pf.id").where("mcp.customer_id","=",""+t.customer_id).andWhere("mcp.product_id","=","1").then(function(e){e=e[0];"1"==o?(a.hasOwnProperty("admin")&&(i.admin=1==r.admin?"1":(r.admin,"0")),a.hasOwnProperty("balancerestriction")&&(i.balance_restriction=1==r.balancerestriction?1:(r.balancerestriction,0)),a.hasOwnProperty("calltransfer")&&e.call_transfer&&(i.call_transfer=1==r.calltransfer?1:(r.calltransfer,0)),a.hasOwnProperty("callforward")&&e.forward&&(i.forward=1==r.callforward?1:(r.callforward,0)),a.hasOwnProperty("dnd")&&(i.dnd=1==r.dnd?1:(r.dnd,0)),a.hasOwnProperty("findmefollowme")&&e.find_me_follow_me&&(i.find_me_follow_me=1==r.findmefollowme?1:(r.findmefollowme,0)),a.hasOwnProperty("multiplereg")&&(i.multiplereg=1==r.multiplereg?1:(r.multiplereg,0)),a.hasOwnProperty("misscallalert")&&e.miss_call_alert&&(i.miss_call_alert=1==r.misscallalert?1:(r.misscallalert,0)),a.hasOwnProperty("outboundsmsnotification")&&e.sms&&(i.outbound_sms_notification=1==r.outboundsmsnotification?1:(r.outboundsmsnotification,0)),a.hasOwnProperty("recording")&&e.recording&&(i.recording=1==r.recording?1:(r.recording,0)),a.hasOwnProperty("roaming")&&e.roaming&&(i.roaming=1==r.roaming?1:(r.roaming,0)),a.hasOwnProperty("speeddial")&&e.speed_dial&&(i.speed_dial=1==r.speeddial?1:(r.speeddial,0)),a.hasOwnProperty("stickyagent")&&e.sticky_agent&&(i.sticky_agent=1==r.stickyagent?1:(r.stickyagent,0)),a.hasOwnProperty("outbound")&&e.outbound_call&&(i.outbound=1==r.outbound?1:(r.outbound,0)),a.hasOwnProperty("ringtone")&&e.custom_prompt&&(i.ringtone=1==r.ringtone?1:(r.ringtone,0)),e=knex.from(table_1.Table.tbl_Extension_Master).select(knex.raw("COUNT(id) as count")).where("ext_number",l).andWhere("customer_id",t.customer_id),console.log(e.toQuery()),e.then(function(e){0==e[0].count?(s.apiInstance.log(403,"Forbidden - User has no permission for this extension.","updateExtensionFeatures","pbx","",l,JSON.stringify(r)),n.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for this extension"})):knex.from(table_1.Table.tbl_Extension_Master+" as ext").update(i).where("ext.ext_number","=",l).andWhere("customer_id",t.customer_id).then(function(e){console.log(e,"-----------------------"),s.apiInstance.log(200,"Extension features updated.","updateExtensionFeatures","pbx","",t.ext_number),n.json({status_code:200,message:"Extension features updated."})}).catch(function(e){throw logger_util_1.errorLog(e),n.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request.","updateExtensionFeatures","pbx","",l,JSON.stringify(r)),e})}).catch(function(e){throw logger_util_1.errorLog(e),n.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request."+e,"updateExtensionFeatures","pbx","",t.ext_number,JSON.stringify(r)),e})):(s.apiInstance.log(403,"Forbidden - User has no permission for perform this action.","updateExtensionFeatures","pbx","","",""),n.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for perform this action"}))}).catch(function(e){throw logger_util_1.errorLog(e),n.status(400).send({status_code:400,message:"Bad Request :"+e}),s.apiInstance.log(400,"Bad Request : "+e,"updateExtensionFeatures","pbx","",l,JSON.stringify(r)),e})},e}();exports.ExtensionService=ExtensionService;