"use strict";var __awaiter=this&&this.__awaiter||function(e,i,o,l){return new(o=o||Promise)(function(s,t){function a(e){try{r(l.next(e))}catch(e){t(e)}}function n(e){try{r(l.throw(e))}catch(e){t(e)}}function r(e){var t;e.done?s(e.value):((t=e.value)instanceof o?t:new o(function(e){e(t)})).then(a,n)}r((l=l.apply(e,i||[])).next())})},__generator=this&&this.__generator||function(s,a){var n,r,i,o={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]},e={next:t(0),throw:t(1),return:t(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(n)throw new TypeError("Generator is already executing.");for(;o;)try{if(n=1,r&&(i=2&t[0]?r.return:t[0]?r.throw||((i=r.return)&&i.call(r),0):r.next)&&!(i=i.call(r,t[1])).done)return i;switch(r=0,(t=i?[2&t[0],i.value]:t)[0]){case 0:case 1:i=t;break;case 4:return o.label++,{value:t[1],done:!1};case 5:o.label++,r=t[1],t=[0];continue;case 7:t=o.ops.pop(),o.trys.pop();continue;default:if(!(i=0<(i=o.trys).length&&i[i.length-1])&&(6===t[0]||2===t[0])){o=0;continue}if(3===t[0]&&(!i||t[1]>i[0]&&t[1]<i[3])){o.label=t[1];break}if(6===t[0]&&o.label<i[1]){o.label=i[1],i=t;break}if(i&&o.label<i[2]){o.label=i[2],o.ops.push(t);break}i[2]&&o.ops.pop(),o.trys.pop();continue}t=a.call(s,o)}catch(e){t=[6,e],r=0}finally{n=i=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CustomerService=void 0;var logger_util_1=require("../utils/logger.util"),table_1=require("../dba/table"),api_logs_1=require("../utils/api-logs"),validation_util_1=require("../utils/validation.util"),pushMail_1=require("../utils/pushMail"),fs=require("fs"),JWT=require("jsonwebtoken"),constant_1=require("../utils/constant"),e=require("express"),config=require("../config"),knex=require("../dba/knex.db"),JWTUtil=require("../utils/jwt.util"),CustomerService=function(){function e(){this.apiInstance=new api_logs_1.ApiLogs,this.validationInstance=new validation_util_1.Validation,this.pushEmail=new pushMail_1.PushEmail,this.jwt=new JWTUtil,this.encrypt=new JWTUtil,this.updateCustomerToken=function(e,t){var s=new Date;s.setHours(s.getHours()+1);s=s.toISOString().split("T")[0]+" "+s.toTimeString().split(" ")[0];knex(table_1.Table.tbl_Customer).update({token:e,token_exp_time:s}).where("id",t).then(function(e){console.log(e)})}}return e.prototype.customerCreation=function(m,g,e){return __awaiter(this,void 0,void 0,function(){var t,s,a,n,r,i,o,l,c,u,d=this;return __generator(this,function(e){switch(e.label){case 0:return(t=m.body).accountmanager?[4,this.validationInstance.validateAccountManager(t.accountmanager)]:[3,2];case 1:if(!e.sent())return this.apiInstance.log(402,"Wrong Account Manager Id.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({error:"Wrong accountmanager Id",message:"Please provide the correct accountmanager fields."})];e.label=2;case 2:return t.firstname?t.firstname?[4,this.validationInstance.validateOnlyChar(t.firstname)]:[3,4]:(this.apiInstance.log(402,"Parameter Missing - firstname.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the firstname"})]);case 3:if(!e.sent())return this.apiInstance.log(402,"Only Character allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Character allowed.",message:"Please provide the correct firstname."})];e.label=4;case 4:return 20<t.firstname.length?(this.apiInstance.log(402,"First Name length should be less than 20.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"firstname length.",message:"First Name length should be less than 21."})]):t.lastname?[4,this.validationInstance.validateOnlyChar(t.lastname)]:[3,6];case 5:if(!e.sent())return this.apiInstance.log(402,"Only Character allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Character allowed.",message:"Please provide the correct lastname."})];if(20<t.lastname.length)return this.apiInstance.log(402,"last Name length should be less than 20.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"lastname length.",message:"last Name length should be less than 21."})];e.label=6;case 6:return t.email?t.email?[4,this.validationInstance.validateEmail(t.email)]:[3,8]:(this.apiInstance.log(402,"Parameter Missing - email.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the email"})]);case 7:if(!e.sent())return this.apiInstance.log(402,"Wrong Email Id.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({error:"Wrong Email Id",message:"Please provide the correct email id."})];e.label=8;case 8:return t.email?[4,this.validationInstance.validateCustomerEmailExist(t.email)]:[3,10];case 9:if(e.sent())return this.apiInstance.log(402,"Email already exist.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({error:"Email already exist",message:"Please provide the alternate email."})];e.label=10;case 10:return t.username?!t.username||7<t.username&&t.username<21||!/\s/.test(t.username)?t.mobile?t.mobile?[4,this.validationInstance.validateMobile(t.mobile)]:[3,12]:(this.apiInstance.log(402,"Parameter Missing - mobile.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the mobile"})]):(this.apiInstance.log(402,"Username does not valid.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Ivalid Username",message:"Please enter the correct username."})]):(this.apiInstance.log(402,"Parameter Missing - username.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the username"})]);case 11:if(!e.sent())return this.apiInstance.log(402,"Wrong Mobile Number.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({error:"Wrong Mobile Number",message:"Please provide the correct mobile number."})];e.label=12;case 12:return t.countryid?"number"!=typeof t.countryid?(this.apiInstance.log(402,"Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct countryid."})]):99==t.countryid?[3,14]:[4,this.validationInstance.validateCountry(t.countryid)]:(this.apiInstance.log(402,"Parameter Missing - countryid.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the countryid"})]);case 13:if(s=e.sent(),t.states)return this.apiInstance.log(402,"state not exist.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"state not exist.",message:"state not valid on country id."})];a="",e.label=14;case 14:return 99!=t.countryid?[3,17]:[4,this.validationInstance.validateCountry(t.countryid)];case 15:return 91!=(s=e.sent()).phonecode?[3,17]:t.states?"number"!=typeof t.states?(this.apiInstance.log(402,"Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct states."})]):[4,this.validationInstance.validateState(t.states)]:(this.apiInstance.log(402,"Parameter Missing - states.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the states"})]);case 16:if(!(c=e.sent()))return this.apiInstance.log(402,"Invalid State.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Invalid State.",message:"Please provide the correct states id."})];c.id==t.states?a=c.id:g.json("state not found"),e.label=17;case 17:return t.timezone?"number"!=typeof t.timezone?(this.apiInstance.log(402,"Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct timezone."})]):t.companyname?t.companyname?[4,this.validationInstance.validateCustomerCompany(t.companyname)]:[3,19]:(this.apiInstance.log(402,"Parameter Missing - companyname.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the companyname"})]):(this.apiInstance.log(402,"Parameter Missing - timezone.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the timezone"})]);case 18:if(e.sent())return this.apiInstance.log(402,"Company name already exist.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({error:"Wrong Company Name",message:"Company name already exist."})];e.label=19;case 19:return t.accountmanager?t.accountmanager?[3,21]:[4,this.validationInstance.validateAccountManager(t.accountmanager)]:(this.apiInstance.log(402,"Parameter Missing - accountmanager.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the accountmanager"})]);case 20:if(!e.sent())return this.apiInstance.log(402,"Wrong accountmanager Id.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({error:"Wrong Account Manager",message:"Please provide the correct accountmanager."})];e.label=21;case 21:if(!t.billingtype)return this.apiInstance.log(402,"Parameter Missing - billingtype.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the billingtype"})];if("number"!=typeof t.billingtype)return this.apiInstance.log(402,"Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct billingtype."})];if(1!=t.billingtype&&2!=t.billingtype)return this.apiInstance.log(402,"billingtype should be 1 and 2.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Not Correct value",message:"billingtype should be 1 and 2."})];if(1==t.billingtype){if(t.creditlimit)return this.apiInstance.log(402,"creditlimit not valid on billingtype 1.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"invalid parameter on billing type 1",message:"creditlimit not valid on billingtype 1."})]}else t.creditlimit&&t.creditlimit;return t.packageid?t.packageid?[4,this.validationInstance.validatePackageExist(t.packageid)]:[3,23]:(this.apiInstance.log(402,"Parameter Missing - packageid.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the packageid"})]);case 22:if(e.sent())return this.apiInstance.log(402,"Package does not exist.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({error:"Wrong Package id",message:"Package does not exist."})];e.label=23;case 23:return t.packageid?[4,this.validationInstance.validatePackage(t.packageid)]:[3,25];case 24:if(e.sent())return this.apiInstance.log(402,"Package already in used.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({error:"Wrong Package id",message:"Package already in used."})];e.label=25;case 25:if(t.iscircle){if("number"!=typeof t.iscircle)return this.apiInstance.log(402,"Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct iscircle."})];if(!t.circleid)return this.apiInstance.log(402,"Parameter Missing - circleid.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the circleid"})]}return t.circleid?[4,this.validationInstance.validateCircleExist(t.circleid)]:[3,27];case 26:if(n=e.sent(),"number"!=typeof t.circleid)return this.apiInstance.log(402,"Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct circleid."})];if(n)return this.apiInstance.log(402,"Circle id does not exist.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({error:"Wrong circle id",message:"circleid does not exist."})];e.label=27;case 27:return t.circleid?[4,this.validationInstance.validatePackageBasedOnCircle(t.packageid,t.circleid)]:[3,29];case 28:if(n=e.sent())return this.apiInstance.log(402,"Circle has not any Package with id =."+t.packageid,"customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({error:"Wrong Package/circle id",message:"Circle has not any Package with id ="+t.packageid})];e.label=29;case 29:return"number"!=typeof t.createdby?(this.apiInstance.log(402,"Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct createdby."})]):t.balance&&"number"!=typeof t.balance?(this.apiInstance.log(402,"balance - Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct balance."})]):t.isapitoken&&"number"!=typeof t.isapitoken?(this.apiInstance.log(402,"isapitoken - Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct isapitoken."})]):t.extensionlengthlimit?"number"!=typeof t.extensionlengthlimit?(this.apiInstance.log(402,"extensionlengthlimit - Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct extensionlengthlimit."})]):2!=t.extensionlengthlimit&&3!=t.extensionlengthlimit&&4!=t.extensionlengthlimit?(this.apiInstance.log(402,"Parameter extensionlengthlimit should be 2,3,4","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Not Correct value",message:"Please enter the correct extensionlengthlimit like : 2,3,4"})]):t.monthlyinternationalthreshold&&"number"!=typeof t.monthlyinternationalthreshold?(this.apiInstance.log(402,"monthlyinternationalthreshold - Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct monthlyinternationalthreshold."})]):t.invoiceday?"number"!=typeof t.invoiceday?(this.apiInstance.log(402,"invoiceday - Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct invoiceday."})]):t.invoiceday<=0||29<=t.invoiceday?(this.apiInstance.log(402,"Parameter invoiceday should be from 1 to 28","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Not Correct value",message:"Invoiceday should be from 1 to 28"})]):t.advancepayment&&"number"!=typeof t.advancepayment?(this.apiInstance.log(402,"advancepayment - Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct advancepayment."})]):t.dialoutgroup&&"number"!=typeof t.dialoutgroup?(this.apiInstance.log(402,"dialoutgroup - Only Number allowed.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct dialoutgroup."})]):t.isnotificationemail&&0!==t.isnotificationemail&&1!==t.isnotificationemail?(this.apiInstance.log(402,"Parameter isnotificationemail should be either 1 or 0","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Not Correct value",message:"isnotificationemail should be either 1 or 0"})]):!t.isnotificationemail||!t.hasOwnProperty("notificationemail")&&t.notificationemail?("0"==(m.user_type||1)?(r=m.body,i=r.id||null,m.protocol,m.get("host"),o="",r.user_type="1",r.createdby=r.createdby||2,r.status="1",r.time_zone=r.time_zone||"49",r.balance=r.balance||0,console.log(r.balance,"<======"),r.product_name=["1"],r.iscircle=r.iscircle||0,r.circleid=r.circleid||"",l=r.isapitoken||0,r.token=r.token||"",r.credit_limit=r.credit_limit||0,r.gstnumber=r.gstnumber||"",r.states=r.states||"",r.monthlyinternationalthreshold=r.monthlyinternationalthreshold||0,r.oc_package_name="",r.notificationemail=r.notificationemail||"",r.dialoutgroup=r.dialoutgroup||0,r.callbackurl=r.callbackurl||"",r.advancepayment=r.advancepayment||0,r.lastname=r.lastname||"",r.companyaddress=r.companyaddress||"",r.companyphone=r.companyphone||"",r.domain=r.domain||"",r.ip=r.ip||"",c=this.encrypt.cipher(config.jwt.appSecret),u=c(Math.random().toString(36).slice(-8)),i?"1"==r.user_type||r.user_type:"1"==r.user_type?0:"2"==r.user_type?o=r.permission_type:0,console.log(knex.raw("Call pbx_create_customer("+i+",'"+r.firstname+"','"+r.lastname+"','"+r.email+"','"+r.mobile+"','"+r.username+"','"+u.toString()+"','"+Math.round(+new Date/1e3)+"','"+r.companyname+"','"+r.companyaddress+"','"+r.companyphone+"','"+r.user_type+"','"+r.domain+"','"+r.createdby+"','"+r.status+"','"+(r.accountmanager||"0")+"','"+r.countryid+"','"+r.countrycode+"','"+r.timezone+"','"+r.billingtype+"','"+r.balance+"','"+r.creditlimit+"','"+r.gstnumber+"','"+r.packageid+"' ,'"+r.oc_package_name+"','"+r.product_name+"', '"+r.states+"', '"+r.iscircle+"', '"+r.circleid+"', '"+r.isapitoken+"', '"+r.token+"', '"+o+"',"+(r.product_name?r.product_name.length:1)+","+r.extensionlengthlimit+","+r.monthlyinternationalthreshold+","+r.invoiceday+","+r.advancepayment+",'"+r.callbackurl+"',"+r.dialoutgroup+",'"+r.isnotificationemail+"','"+r.notificationemail+"')").toString()),console.log("======>","isapitoken",l,"<======="),knex.raw("Call pbx_create_customer("+i+",'"+r.firstname+"','"+r.lastname+"','"+r.email+"','"+r.mobile+"','"+r.username+"','"+u.toString()+"','"+Math.round(+new Date/1e3)+"','"+r.companyname+"','"+r.companyaddress+"','"+r.companyphone+"','"+r.user_type+"','"+r.domain+"','"+r.createdby+"','"+r.status+"','"+(r.accountmanager||"0")+"','"+r.countryid+"','"+s.phonecode+"','"+r.timezone+"','"+r.billingtype+"','"+r.balance+"','"+r.creditlimit+"','"+r.gstnumber+"','"+r.packageid+"' ,'"+r.oc_package_name+"','"+r.product_name+"', '"+a+"', '"+r.iscircle+"', '"+r.circleid+"', '"+r.isapitoken+"', '"+r.token+"', '"+o+"',"+(r.product_name?r.product_name.length:1)+","+r.extensionlengthlimit+","+r.monthlyinternationalthreshold+","+r.invoiceday+","+r.advancepayment+",'"+r.callbackurl+"',"+r.dialoutgroup+",'"+r.isnotificationemail+"','"+r.notificationemail+"','"+r.ip+")").then(function(t){var e,s;t&&(s=t[0][0][0].lastInserted,console.log(s),e={id:s,package_id:"",customer_id:s,ext_number:"",token:"",user_type:r.user_type},e=JWT.sign(e,config.jwt.secret),console.log("upgradeToken",e),d.updateCustomerToken(e,s),"1"==r.user_type&&200==t[0][0][0].MYSQL_SUCCESSNO&&null==i&&d.ensureExists(__dirname+"/../upload/"+t[0][0][0].lastInserted,493,function(e){e?console.log("customer dir not created. "+e):(this.ensureExists(__dirname+"/../upload/"+t[0][0][0].lastInserted+"/prompts",493,function(e){e?console.log("prompts dir not created. "+e):console.log("prompts dir created.")}),this.ensureExists(__dirname+"/../upload/"+t[0][0][0].lastInserted+"/vm",493,function(e){e?console.log("vm dir not created. "+e):console.log("vm dir created.")}),this.ensureExists(__dirname+"/../upload/"+t[0][0][0].lastInserted+"/recording",493,function(e){e?console.log("recording dir not created. "+e):console.log("recording dir created.")}))}),s=d.encrypt.decipher(config.jwt.appSecret)(u.toString()),console.log("decrypted==",s),g.send({code:t[0][0][0].MYSQL_SUCCESSNO,message:t[0][0][0].MESSAGE_TEXT,username:r.username,user_id:t[0][0][0].lastInserted,CompanyName:r.company_name,password:s}))}).catch(function(e){throw logger_util_1.errorLog(e),g.status(400).send({status_code:400,message:"Bad Request"}),d.apiInstance.log(400,"Bad Request : "+e,"customerCreation","pbx","",m.ext_number,JSON.stringify(t)),e})):(this.apiInstance.log(403,"Forbidden - User has no permission for perform this action.","customerCreation","pbx","","",""),g.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for perform this action"})),[2]):(this.apiInstance.log(402,"Parameter Missing - notificationemail.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the notificationemail"})]):(this.apiInstance.log(402,"Parameter Missing - invoiceday.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the invoiceday"})]):(this.apiInstance.log(402,"Parameter Missing - extensionlengthlimit.","customerCreation","pbx","",m.ext_number,JSON.stringify(t)),[2,g.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the extensionlengthlimit"})])}})})},e.prototype.ensureExists=function(e,t,s){fs.mkdir(e,t,function(e){!e||"EEXIST"==e.code?s(null):s(e)})},e.prototype.getCustomers=function(e,t,s,a){var n=this;if("0"==(e.user_type||1)){var r=e.query.type;if(r==constant_1.UserTypeConstants.ACCOUNT_MANAGER)knex.raw("Call pbx_getinternalusersbyfilters(null,null,null,null, "+r+")").then(function(e){var s;e.length?(e=e[0][0]?JSON.parse(JSON.stringify(e[0][0])):[],s=[],e.forEach(function(e){var t={};t.id=e.id,t.firstname=e.first_name,t.email=e.email,t.username=e.username,s.push(t)}),t.json({status_code:200,message:"Account Manager Listing.",data:s}),n.apiInstance.log(200,"Account Manager Listing Info.","getCustomer",a,"","")):(t.status(201).send({status_code:201,message:"No Data found"}),n.apiInstance.log(201,"No Data found.","getCustomer",a,"","",""))}).catch(function(e){throw logger_util_1.errorLog(e),t.status(400).send({status_code:400,message:"Bad Request"}),n.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getCustomer",a,"","",""),e});else{if(r!=constant_1.UserTypeConstants.CUSTOMER)return this.apiInstance.log(406,"Unauthorize Type - Parameter Type is incorrect.","getCustomer","pbx","","",e.query),t.status(406).send({status_code:406,error:"Parameter Type is incorrect",message:"Please enter the correct type"});knex.raw("Call pbx_getAllUser()").then(function(e){var s;e.length?(e=e[0][0]?JSON.parse(JSON.stringify(e[0][0])):[],s=[],e.forEach(function(e){var t={};t.id=e.id,t.firstname=e.first_name,t.email=e.email,t.username=e.username,s.push(t)}),t.json({status_code:200,message:"Customer Listing.",data:s}),n.apiInstance.log(200,"Customer Listing Info.","getCustomer",a,"","")):(t.status(201).send({status_code:201,message:"No Data found"}),n.apiInstance.log(201,"No Data found.","getCustomer",a,"","",""))}).catch(function(e){throw logger_util_1.errorLog(e),t.status(400).send({status_code:400,message:"Bad Request"}),n.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getCustomer",a,"","",""),e})}}else this.apiInstance.log(403,"Forbidden - User has no permission for perform this action.","getCustomer",a,"","",""),t.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for perform this action"})},e.prototype.didPurchase=function(t,u,e,d){return __awaiter(this,void 0,void 0,function(){var l,c=this;return __generator(this,function(e){switch(e.label){case 0:return(l=t.body).did_id?"1"!=(t.user_type||1)?[3,3]:[4,this.didExistOrNot(l.did_id)]:(this.apiInstance.log(402,"Parameter Missing - did_id.","didPurchase","pbx","",t.ext_number,JSON.stringify(l)),[2,u.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the did_id"})]);case 1:return e.sent()?[4,this.didReservedOrNot(l.did_id)]:(this.apiInstance.log(402,"did does not exist.","didPurchase","pbx","",t.ext_number,JSON.stringify(l)),[2,u.status(402).send({status_code:402,error:"DID does not exist",message:"Please enter the correct did_id"})]);case 2:return e.sent()?(knex.select("d.*").from(table_1.Table.tbl_DID+" as d").where("d.id",l.did_id).then(function(e){var r,i,t,o;e.length?(r=e[0],i=r.id,t=r.did,e=r.did_type,o="",o="1"==e||"2"==e?"Charge for DID - "+t:"Charge for TFN - "+t,console.log(r),console.log("did_id",i),knex(table_1.Table.tbl_DID).where("id","=",""+i).update({reserved:"1",customer_id:r.customer_id,product_id:r.product_id}).then(function(e){knex.from(table_1.Table.tbl_DID+" as did").where("did.id",""+i).leftJoin(table_1.Table.tbl_Customer+" as c","c.id","did.customer_id").leftJoin(table_1.Table.tbl_Country+" as cntr","cntr.id","did.country_id").select("did.fixrate","c.company_name","cntr.nicename","c.first_name","c.last_name").then(function(e){e[0].nicename,e[0].company_name;var t=e[0].first_name+(e[0].last_name||""),s=new Date,a=s.getFullYear(),n=s.getMonth()+1,s=s.getDate(),n=new Date(a,n,0).getDate(),n=(1+(Number(n)-Number(s)))*(Number(e[0].fixrate)/n);console.log(n),knex(table_1.Table.tbl_Charge).insert({did_id:""+i,customer_id:""+r.customer_id,amount:""+n.toFixed(2),charge_type:"1",description:""+o,charge_status:0,invoice_status:0,product_id:r.product_id}).then(function(e){e?knex(table_1.Table.tbl_Uses).insert({did_id:""+i,customer_id:""+r.customer_id}).then(function(e){e?(c.apiInstance.log(200,"DID purchased sucessfully - "+t,"didPurchase",d,"","",""),u.status(200).send({status_code:200,message:"DID purchased sucessfully."})):(c.apiInstance.log(400,"Error while insert data into did_uses.","didPurchase",d,"","",JSON.stringify(l)),u.status(400).send({status_code:400,message:"Error while insert data into did_uses."}))}).catch(function(e){throw c.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"didPurchase",d,"","",""),u.status(400).send({status_code:400,message:"Bad Request"+e.sqlMessage}),e}):(c.apiInstance.log(400,"Error while insert data into charge.","didPurchase",d,"","",JSON.stringify(l)),u.status(400).send({status_code:400,message:"Error while insert data into charge."}))}).catch(function(e){throw c.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"didPurchase",d,"","",""),u.status(400).send({status_code:400,message:"Bad Request"+e.sqlMessage}),e})}).catch(function(e){throw c.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"didPurchase",d,"","",""),u.status(400).send({status_code:400,message:"Bad Request"+e.sqlMessage}),e})}).catch(function(e){throw c.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"didPurchase",d,"","",""),u.status(400).send({status_code:400,message:"Bad Request"+e.sqlMessage}),e})):(c.apiInstance.log(201,"DID not exist","didPurchase",d,"","",JSON.stringify(l)),u.status(201).send({status_code:201,message:"DID not exist"}))}).catch(function(e){throw c.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"didPurchase",d,"","",""),u.status(400).send({status_code:400,message:"Bad Request"+e.sqlMessage}),e}),[3,4]):(this.apiInstance.log(402,"DID already reserved.","didPurchase",d,"",t.ext_number,JSON.stringify(l)),[2,u.status(402).send({status_code:402,error:"DID already reserved.",message:"Please enter the correct did_id"})]);case 3:this.apiInstance.log(403,"Forbidden - User has no permission for perform this action.","didPurchase",d,"","",""),u.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for perform this action"}),e.label=4;case 4:return[2]}})})},e.prototype.didExistOrNot=function(e){return knex.select("d.*").from(table_1.Table.tbl_DID+" as d").where("d.id",e).then(function(e){return!!e.length})},e.prototype.didReservedOrNot=function(e){return knex.select("d.*").from(table_1.Table.tbl_DID+" as d").where("d.id",e).andWhere("d.reserved","1").then(function(e){return!!e.length})},e.prototype.UpdateCustomerDetail=function(i,o,l){return __awaiter(this,void 0,void 0,function(){var t,s,a,n,r=this;return __generator(this,function(e){switch(e.label){case 0:return(t=i.customer_id||null,s=i.user_type||"1",a=i.body,n={},"1"!=s)?[3,15]:a.first_name?(20<a.first_name.length&&(this.apiInstance.log(402,"First Name length should be less than 21.","UpdateCustomerDetail","",i.customer_id,JSON.stringify(a)),o.status(402).send({error:"First Name Length",message:"First Name length should be less than 21."})),[4,this.validationInstance.validateOnlyChar(a.first_name)]):[3,2];case 1:if(!e.sent())return this.apiInstance.log(402,"Only Character allowed.","UpdateCustomer","",i.customer_id,JSON.stringify(a)),[2,o.status(402).send({status_code:402,error:"Only Character allowed.",message:"Please provide the correct firstname."})];n.first_name=a.first_name,e.label=2;case 2:return a.last_name?[4,this.validationInstance.validateOnlyChar(a.last_name)]:[3,4];case 3:if(!e.sent())return this.apiInstance.log(402,"Only Character allowed.","UpdateCustomer","",i.customer_id,JSON.stringify(a)),[2,o.status(402).send({status_code:402,error:"Only Character allowed.",message:"Please provide the correct Lastname."})];n.last_name=a.last_name,e.label=4;case 4:return a.mobile?10<a.mobile.toString().length?(this.apiInstance.log(400,"invalid input.","","customer Update."),[2,o.status(400).send({status_code:400,error:"invalid length.",message:"please provide valid mobile number."})]):[4,this.validationInstance.validateMobile(a.mobile)]:[3,6];case 5:if(0==e.sent())return this.apiInstance.log(402,"Wrong Mobile Number.","UpdateCustomer","",i.customer_id,JSON.stringify(a)),[2,o.status(402).send({status_code:402,error:"Wrong Mobile Number.",message:"Please provide correct mobile number."})];n.mobile=a.mobile,e.label=6;case 6:return a.company_name?[4,this.validationInstance.validateCustomerCompany(a.company_name)]:[3,8];case 7:if(e.sent())return this.apiInstance.log(402,"Company name already exist.","UpdateCustomer","",i.customer_id,JSON.stringify(a)),[2,o.status(402).send({error:"Wrong Company Name",message:"Company name already exist."})];n.company_name=a.company_name,e.label=8;case 8:if(a.company_phone){if("0"==String(a.company_phone)[0]||a.company_phone.toString().length<10||15<a.company_phone.toString().length)return this.apiInstance.log(402,"not start with 0","UpdateCustomer","",i.customer_id,JSON.stringify(a)),[2,o.status(402).send({error:"number not allowed.",message:"Number can not start with 0 and not less than 10 digits."})];n.phone=a.company_phone}if(a.status){if("0"!=a.status&&"1"!=a.status&&"2"!=a.status&&"3"!=a.status&&"4"!=a.status&&"5"!=a.status)return this.apiInstance.log(400,"status should be 0, 1, 2, 3 & 4.","CustomerUpdate","",i.customer_id,JSON.stringify(a)),[2,o.status(400).send({status_Code:402,error:"status should be 0, 1, 2, 3, 4 & 5.",message:"Please provide correct status."})];n.status=a.status}return a.account_manager?(n.account_manager_id=a.account_manager,[4,this.validationInstance.validateAccountManager(a.account_manager)]):[3,10];case 9:if(0==e.sent())return this.apiInstance.log(400,"Wrong accountmanager Id.","customerCreation","",i.customer_id,JSON.stringify(a)),[2,o.status(400).send({status_code:400,error:"Wrong Account Manager",message:"Please provide the correct account manager."})];e.label=10;case 10:if(a.time_zone&&(n.timezone=a.time_zone,"number"!=typeof a.time_zone))return this.apiInstance.log(402,"Only Number allowed.","customerCreation","pbx","",i.customer_id,JSON.stringify(a)),[2,o.status(402).send({status_code:402,error:"Only Number allowed.",message:"time zone should be number."})];if(a.GST&&(n.company_gst_number=a.GST),a.billing){if("1"!=a.billing&&"2"!=a.billing)return this.apiInstance.log(402,"Only Number allowed.","CustomerUpdate","pbx","",i.customer_id,JSON.stringify(a)),[2,o.status(402).send({status_code:402,error:"Only Number allowed.",message:"Please provide the correct billing type."})];n.billing_type=a.billing}return(a.advanced_pay&&(n.advance_payment=a.advanced_pay||"0.00"),a.invoice&&a.invoice<29&&(n.invoice_day=a.invoice),a.dialout_id)?(n.dialout_group=a.dialout_id,[4,this.validationInstance.validateDialOut(a.dialout_id)]):[3,12];case 11:if(0==e.sent())return this.apiInstance.log(400,"invalid Parameter.","","update Customer."),[2,o.status(400).send({status_code:400,error:"Invalid data.",message:"dialout does not exist."})];e.label=12;case 12:return(a.email_notify&&(n.is_email_notification=a.email_notify,a.popup_email&&(n.notification_email=a.popup_email)),Number(a.call_limit)&&(n.monthly_international_threshold=a.call_limit,3<a.call_limit.toString().length))?(this.apiInstance.log(402,"length excedd.","","update Customer."),[2,o.status(402).send({status_code:402,error:"length not suitable.",message:"please provide valid number."})]):(a.ip&&(n.ip=a.ip),a.product?1!=a.product&&2!=a.product?(this.apiInstance.log(402,"Product Should be either 0 or 1.","CustomerUpdate","pbx","",i.customer_id,JSON.stringify(a)),[2,o.status(402).send({status_code:402,error:"Invalid data.",message:"Product Should be either 0 or 1."})]):1!=a.product?[3,14]:a.extension_length_limit&&(n.extension_length_limit=a.extension_length_limit,"number"!=a.extension_length_limit&&2!=a.extension_length_limit&&3!=a.extension_length_limit&&4!=a.extension_length_limit)?(this.apiInstance.log(402,"Product Should only number 2, 3 & 4.","CustomerUpdate","",i.customer_id,JSON.stringify(a)),[2,o.status(402).send({status_code:402,error:"Product Should only number 2, 3 & 4.",message:"Please provide the correct Value."})]):a.package_id?[4,this.validationInstance.validatePackage]:[3,14]:[3,14]);case 13:e.sent(),e.label=14;case 14:return n.api_token=a.apitoken||"1",n.credit_limit=a.credit_limit||0,a.domain&&(n.domain=a.domain),a.company_address&&(n.company_address=a.company_address),a.email?(n.email=a.email,knex("customer").select(knex.raw("COUNT(id) as count")).where("email",a.email).whereNot("id",i.customer_id).then(function(e){return 0<e[0].count?(r.apiInstance.log(402,"Email already Exist.","CustomerUpdate","",i.customer_id,JSON.stringify(a)),o.status(402).send({status_code:402,error:"Email already Exist.",message:"please provide anouther email."})):void r.updateCustomer(i,o,l,n,t,a)})):this.updateCustomer(i,o,l,n,t,a),[3,16];case 15:return this.apiInstance.log(400,"Customer not valid","CustomerUpdate","",i.customer_id,JSON.stringify(a)),[2,o.status(400).send({status_code:402,error:"unknown customer",message:"please provide valid customer."})];case 16:return[2]}})})},e.prototype.updateCustomer=function(t,s,e,a,n,r){var i=this;knex("customer").update(a).where("id",n).then(function(e){return e?(i.apiInstance.log(200,"Customer Updated Successfully.","CustomeUpdate","",t.customer_id,JSON.stringify(r)),s.status(402).send({status_code:200,message:"Customer Updated Successfully."})):(i.apiInstance.log(402,"customer not update","CustomerUpdate","",t.customer_id,JSON.stringify(r)),s.status(402).send({status_code:402,error:"Bad request",message:"customer not updated."}))}).catch(function(e){return i.apiInstance.log(400,"Bad Request.","","customer Update."),s.status(400).send({status_code:400,error:"Bad Request."})})},e}();exports.CustomerService=CustomerService;