"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.RecordingService=void 0;var logger_util_1=require("../utils/logger.util"),table_1=require("../dba/table"),api_logs_1=require("../utils/api-logs"),knex=require("../dba/knex.db"),RecordingService=function(){function e(){this.apiInstance=new api_logs_1.ApiLogs}return e.prototype.getExtensionRecording=function(e,t,a){var s=this,r=e.ext_number||0,o=(o=e.headers.host).replace("3001","3000");e.body;knex.from(table_1.Table.tbl_Recording+" as r").select("r.*","r.src as extension","r.dest as callee_ext","r.created_at as time",knex.raw('CONCAT("/assets/prompts/",r.customer_id,"/recording/",r.file_name) as file_path'),"r.type as call_type").andWhere(function(e){return e.where("r.src","=",r).orWhere("r.dest","=",r)}).orderBy("r.id","desc").then(function(e){e.length?((e||[]).map(function(e){return delete e.id,delete e.customer_id,delete e.status,delete e.created_at,delete e.updated_at,delete e.extension,delete e.callee_ext,delete e.type,e.file_path=o+e.file_path,e}),t.json({data:e,status_code:200,message:"Recording listing."}),s.apiInstance.log(200,"Recording listing.","getExtensionRecording","pbx","",r)):(t.status(201).send({status_code:201,message:"No Data found"}),s.apiInstance.log(201,"No Data found.","getExtensionRecording","pbx","",r))}).catch(function(e){throw logger_util_1.errorLog(e),t.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getExtensionRecording","pbx","",r),e})},e.prototype.getExtensionVoicemailRecording=function(e,t,a){var s=this,r=e.ext_number||0,o=(o=e.headers.host).replace("3001","3000");console.log(e.headers),knex.from(table_1.Table.tbl_Voicemail_Recording+" as r").select("r.*","r.src as extension","r.dest as callee_ext","r.created_at as time",knex.raw('CONCAT("/assets/prompts/",r.customer_id,"/vm/","@extNumber","/",r.file_name) as file_path')).andWhere(function(e){return e.where("r.src","=",r).orWhere("r.dest","=",r)}).orderBy("r.id","desc").then(function(e){e.length?((e||[]).map(function(e){return delete e.id,delete e.customer_id,delete e.status,delete e.created_at,delete e.updated_at,delete e.extension,delete e.callee_ext,e.file_path=o+e.file_path.replace("@extNumber",r),e}),t.json({data:e,status_code:200,message:"Voicemail Recording listing."}),s.apiInstance.log(200,"Voicemail Recording listing.","getExtensionVoicemailRecording","pbx","",r)):(t.send({data:[],status_code:201,message:"No Data found."}),s.apiInstance.log(201,"No Data found.","getExtensionVoicemailRecording","pbx","",r))}).catch(function(e){throw logger_util_1.errorLog(e),t.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getExtensionVoicemailRecording","pbx","",r),e})},e.prototype.getCustomerRecording=function(e,t,a){var s,r=this,o=e.customer_id||0;1==o&&(s=(s=e.headers.host).replace("3001","3000"),e.body,knex.from(table_1.Table.tbl_Recording+" as r").select("r.*","r.src as extension","r.dest as callee_ext","r.created_at as time",knex.raw('CONCAT("/assets/prompts/",r.customer_id,"/recording/",r.file_name) as file_path'),"r.type as call_type").where("r.customer_id",o).orderBy("r.id","desc").then(function(e){e.length?((e||[]).map(function(e){return delete e.id,delete e.customer_id,delete e.status,delete e.created_at,delete e.updated_at,delete e.extension,delete e.callee_ext,delete e.type,e.call_type="cg"==e.call_type?"call group":"call_conference"==e.call_type?"conference":"call_voicmail"==e.call_type?"voicmail":"sip_extn"==e.call_type?"sip call":"call_queue"==e.call_type?"queue":"tc"==e.call_type?"tele consultancy":"call_group"==e.call_type?"call group":e.call_type,e.file_path=s+e.file_path,e}),t.json({data:e,status_code:200,message:"Recording listing."}),r.apiInstance.log(200,"Customer Voicemail Recording listing.","getCustomerVoicemailRecording","pbx",o,"")):(t.status(201).send({status_code:201,message:"No Data found"}),r.apiInstance.log(201,"No Data found.","getCustomerVoicemailRecording","pbx"))}).catch(function(e){throw logger_util_1.errorLog(e),t.status(400).send({status_code:400,message:"Bad Request : "+e.sqlMessage}),r.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getCustomerVoicemailRecording","pbx"),e}))},e.prototype.getCRMRecording=function(e,t,a){var s=this,r=e.ext_number||0,o=(o=e.headers.host).replace("3001","3000");e.body;knex.from(table_1.Table.tbl_Recording+" as r").select("r.*","r.src as extension","r.dest as callee_ext","r.created_at as time",knex.raw('CONCAT("/assets/prompts/",r.customer_id,"/recording/",r.file_name) as file_path'),"r.type as call_type").andWhere(function(e){return e.where("r.src","=",r).orWhere("r.dest","=",r)}).orderBy("r.id","desc").then(function(e){e.length?((e||[]).map(function(e){return delete e.id,delete e.customer_id,delete e.status,delete e.created_at,delete e.updated_at,delete e.extension,delete e.callee_ext,delete e.type,e.file_path=o+e.file_path,e}),t.json({data:e,status_code:200,message:"Recording listing."}),s.apiInstance.log(200,"Recording listing.","getCRMRecording","crm","",r)):(t.status(201).send({status_code:201,message:"No Data found"}),s.apiInstance.log(201,"No Data found.","getCRMRecording","crm","",r))}).catch(function(e){throw logger_util_1.errorLog(e),t.status(400).send({status_code:400,message:"Bad Request"}),s.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getCRMRecording","crm","",r),e})},e}();exports.RecordingService=RecordingService;