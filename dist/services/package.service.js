"use strict";var __awaiter=this&&this.__awaiter||function(e,r,l,o){return new(l=l||Promise)(function(t,a){function s(e){try{n(o.next(e))}catch(e){a(e)}}function i(e){try{n(o.throw(e))}catch(e){a(e)}}function n(e){var a;e.done?t(e.value):((a=e.value)instanceof l?a:new l(function(e){e(a)})).then(s,i)}n((o=o.apply(e,r||[])).next())})},__generator=this&&this.__generator||function(t,s){var i,n,r,l={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},e={next:a(0),throw:a(1),return:a(2)};return"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function a(a){return function(e){return function(a){if(i)throw new TypeError("Generator is already executing.");for(;l;)try{if(i=1,n&&(r=2&a[0]?n.return:a[0]?n.throw||((r=n.return)&&r.call(n),0):n.next)&&!(r=r.call(n,a[1])).done)return r;switch(n=0,(a=r?[2&a[0],r.value]:a)[0]){case 0:case 1:r=a;break;case 4:return l.label++,{value:a[1],done:!1};case 5:l.label++,n=a[1],a=[0];continue;case 7:a=l.ops.pop(),l.trys.pop();continue;default:if(!(r=0<(r=l.trys).length&&r[r.length-1])&&(6===a[0]||2===a[0])){l=0;continue}if(3===a[0]&&(!r||a[1]>r[0]&&a[1]<r[3])){l.label=a[1];break}if(6===a[0]&&l.label<r[1]){l.label=r[1],r=a;break}if(r&&l.label<r[2]){l.label=r[2],l.ops.push(a);break}r[2]&&l.ops.pop(),l.trys.pop();continue}a=s.call(t,l)}catch(e){a=[6,e],n=0}finally{i=r=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,e])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageService=void 0;var logger_util_1=require("../utils/logger.util"),table_1=require("../dba/table"),api_logs_1=require("../utils/api-logs"),validation_util_1=require("../utils/validation.util"),knex=require("../dba/knex.db"),PackageService=function(){function e(){this.apiInstance=new api_logs_1.ApiLogs,this.validateInstance=new validation_util_1.Validation}return e.prototype.PackageCreation=function(e,a,t){var s=this,i=(e.user_type,e.body);if(!i.product)return this.apiInstance.log(402,"Parameter Missing In Params - product type.","create Package.","",""),a.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the product type in parameter"});if(1!=i.product&&2!=i.product)return this.apiInstance.log(402,"Invalid value. - product type.","create Package.","",""),a.status(402).send({status_code:402,error:"Invalid value.",message:"product id should be either 0 or 1"});if(1==i.product){if(!i.package_name)return this.apiInstance.log(402,"Parameter Missing In Params - product type.","create Package.","",""),a.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the package id in parameter"});if(i.concurrent_call){if(3<i.concurrent_call.toString().length)return this.apiInstance.log(400,"Invalid length.","create Package.","",""),a.status(400).send({status_code:402,error:"length exceed.",message:"Concurrents call max length is 3 character long."});if("number"!=typeof i.concurrent_call)return this.apiInstance.log(400,"Type-Missmatch.","create Package.","",""),a.status(400).send({status_code:402,error:"Type-Missmatch.",message:"concurrent call can not be sring."})}if(!i.phone_book)return this.apiInstance.log(402,"Parameter Missing In Params - product type.","create Package.","",""),a.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the phone book in parameter"});if(3<i.phone_book.toString().length)return this.apiInstance.log(402,"phone book length can not be greater from phone book","packageupdate",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid length.",message:"phone book length should be less than 4."});if("number"!=typeof i.phone_book)return this.apiInstance.log(402,"phone number should be number","packageupdate",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid value.",message:"phone book should be number."});if(i.phone_book<50)return this.apiInstance.log(402,"phone book can not be less than 50","packageupdate",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid length.",message:"phone book can not be less than 50"});if(i.extension_limit){if("number"!=typeof i.extension_limit)return this.apiInstance.log(402,"extension limit should be number","packageupdate",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid value.",message:"extension limit should be number."});if(4<i.extension_limit.toString().length)return this.apiInstance.log(402,"extension limit length can not be greater 4","packageupdate",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid length.",message:"extension limit length can not be greater 4"})}if(i.minute_plan){if(1!=i.minute_plan&&0!=i.minute_plan)return this.apiInstance.log(402,"Minute plan should be either 0 or 1.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid parameter",message:"Minute plan should be either 0 or 1"});if(1==i.minute_plan){if(!i.bundle&&!i.roaming&&!i.teleConsultancy)return this.apiInstance.log(402,"please choose atleast one from bundle, roaming, teleconsulatat.","packageupdate",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid value.",message:"please choose atleast one from bundle, roaming, teleconsulatat."});if(i.bundle){if(1!=i.bundle&&0!=i.bundle)return this.apiInstance.log(402,"bundle plan should be either 0 or 1.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid parameter",message:"bundle plan should be either 0 or 1"});if(1==i.bundle){if(!i.bundle_plan_id)return this.apiInstance.log(402,"please provide bundle plan id.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Missing Parameter.",message:"please provide bundle plan id."});if("number"!=typeof i.bundle_plan_id)return this.apiInstance.log(402,"bundle plan id should be number.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid value.",message:"bundle plan id should be number."});for(var n=this.validateInstance.validateBundle(1),r=0,l=0;l<n.length;l++){if(n[l].id==i.bundle_plan_id){r=0;break}r++}if(0!=r)return this.apiInstance.log(400,"bundle plan id does not match.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invallid data.",message:"Please provide valid bundle call plan id."})}}if(i.roaming){if(1!=i.roaming&&0!=i.roaming)return this.apiInstance.log(402,"roaming plan should be either 0 or 1.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid parameter",message:"roaming plan should be either 0 or 1"});if(1==i.roaming){if(!i.roaming_plan_id)return this.apiInstance.log(402,"please provide roaming plan id.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Missing-Parameter.",message:"please provide roaming plan id."});if("number"!=typeof i.roaming_plan_id)return this.apiInstance.log(402,"roaming plan id should be number.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid value.",message:"roaming plan id should be number."});for(var o=this.validateInstance.validateBundle(2),r=0,l=0;l<o.length;l++){if(o[l].id==i.roaming_plan_id){r=0;break}r++}if(0!=r)return this.apiInstance.log(400,"roaming plan id does not match.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invalid data.",message:"Please provide valid roaming call plan id."})}}if(i.teleConsultancy){if(1!=i.teleConsultancy&&0!=i.teleConsultancy)return this.apiInstance.log(402,"teleConsultancy should be either 0 or 1.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid parameter",message:"teleConsultancy should be either 0 or 1"});if(1==i.teleConsultancy){if(!i.teleConsultancy_call_plan_id)return this.apiInstance.log(402,"please provide teleConsultancy plan id.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Missing-Parameter.",message:"please provide teleConsultancy plan id."});if("number"!=typeof i.teleConsultancy_call_plan_id)return this.apiInstance.log(402,"teleConsultancy plan id should be number.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid value.",message:"teleConsultancy plan id should be number."});for(var d=this.validateInstance.validateBundle(4),r=0,l=0;l<d.length;l++){if(d[l].id==i.teleConsultancy_call_plan_id){r=0;break}r++}if(0!=r)return this.apiInstance.log(400," plan id does not match.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invalid data.",message:"Please provide valid teleConsultancy call plan id."})}}}}if(i.sms){if(1!=i.sms&&0!=i.sms)return this.apiInstance.log(402,"sms should be either 0 or 1.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid parameter",message:"sms should be either 0 or 1"});if(1==i.sms){if(!i.sms_id)return this.apiInstance.log(402,"please provide sms id based on circle.","create Package.",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invalid value.",message:"please provide sms id based on circle."});if(0==this.validateInstance.ValidateSmsExist(i.sms_id))return this.apiInstance.log(400,"Invalid sms id.","create Package.",JSON.stringify(i)),a.status(400).send({status_code:400,error:"Invalid sms.",message:"please provide valid sms id."})}}if(i.outbound){if(1!=i.outbound&&0!=i.outbound)return this.apiInstance.log(402,"outbound should be either 0 or 1.","","",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid parameter",message:"outbound should be either 0 or 1"});if(1==i.outbound){if(1==i.outbound&&!i.circle){if(!i.call_plan_id)return this.apiInstance.log(402,"please provide call plan id.","create Package.",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invalid value.",message:"please provide call plan id."});if(""==this.validateInstance.validateCallPlanExist(i.call_plan_id))return this.apiInstance.log(402,"please provide valid callplan id.","create Package.",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invalid value.",message:"please provide valid callplan id."})}if(i.circle){if(1!=i.circle&&0!=i.circle)return this.apiInstance.log(402,"circle should be either 0 or 1.","create Package.",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invalid value.",message:"circle should be either 0 or 1."});if(1==i.circle&&1==i.outbound){if(!i.circle_id)return this.apiInstance.log(402,"please provide circle id.","create Package.",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Missing Parameter.",message:"please provide the circle id."});if("number"!=typeof i.circle_id)return this.apiInstance.log(402,"circle id should be number.","create Package.",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invalid value.",message:"circle id should be number.."});if(!i.call_plan_id)return this.apiInstance.log(402,"please provide call plan id based on circle.","create Package.",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invalid value.",message:"please provide call plan id based on circle."});if("number"!=typeof i.call_plan_id)return this.apiInstance.log(402,"call plan id should be number.","create Package.",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invalid value.",message:"call plan id should be number.."});if(1==this.validateInstance.validateCircleExist(i.circle_id))return this.apiInstance.log(402,"please provide valid circle id","create Package.",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invalid data.",message:"Please provide valid circle id."});if(0==this.validateInstance.validateCallPlanBasedOnCircle(i.call_plan_id,i.circle_id))return this.apiInstance.log(402,"please provide valid circle id","create Package.",JSON.stringify(i)),a.status(402).send({status_code:402,error:"does not exist.",message:"call plan does not exist for circle."})}}}}if(i.feature){if(1!=i.feature)return this.apiInstance.log(402,"feature should be only 1.","packageupdate",JSON.stringify(i)),a.status(402).send({status_code:402,error:"invalid value.",message:"feature should be number."});if("number"!=typeof i.feature_rate)return this.apiInstance.log(402,"only number allowed.","packageupdate",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Inavlid Format",message:"please provide only number."});if(0==this.validateInstance.validateFeature(i.feature_rate))return this.apiInstance.log(402,"featureRate not valid.","packageupdate",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invalid data.",message:"Provide valid feature rate."})}i.storage&&1==i.storage&&(i.appointment=i.appointment||"0",i.broadcast=i.broadcast||"0",i.ivr=i.ivr||"0",i.music_on_hold=i.music_on_hold||"0",i.queue=i.queue||"0",i.file_storage_duration=i.file_storage_duration||30,i.file_storage_size=i.file_storage_size||1)}i.concurrent_call=i.concurrent_call||10,i.extension_limit=i.extension_limit||10,i.caller_id=i.caller_id||0,i.call_barging=i.call_barging||0,i.call_group=i.call_group||0,i.call_transfer=i.call_transfer||0,i.recording=i.recording||0,i.click_to_call=i.click_to_call||0,i.conference=i.conference||0,i.custom_acl=i.custom_acl||0,i.feedback_call=i.feedback_call||0,i.find_me_follow_me=i.find_me_follow_me||0,i.forwarding=i.forwarding||0,i.geo_tracking=i.geo_tracking||0,i.one_to_one_video_call=i.one_to_one_video_call||0,i.missed_call_alert=i.missed_call_alert||0,i.paging=i.paging||0,i.playback=i.playback||0,i.speed_dial=i.speed_dial||0,i.whatsapp=i.whatsapp||0,i.sticky_agent=i.sticky_agent||0,i.circle_id=i.circle_id||0,i.feature_id=i.feature_id||0,i.sms_id=i.sms_id||0,knex(table_1.Table.tbl_Package).where("name",i.package_name).select("name").then(function(e){return 0<e.length?(s.apiInstance.log(400,"package already exist.","","create Package."),a.status(400).send({status_code:400,error:"Duplicate Package.",message:"package already exist."})):void knex(table_1.Table.tbl_Features).insert({black_list:"1",voicemail:"1",voicemail_limit:"10",ivr:""+i.ivr,call_transfer:""+i.call_transfer,forward:""+i.forwarding,concurrent_call:""+i.concurrent_call,recording:""+i.recording,phone_book:""+i.phone_book,outbound_call:""+i.outbound,click_to_call:""+i.click_to_call,music_on_hold:""+i.music_on_hold,paging:""+i.paging,speed_dial:""+i.speed_dial,ring_time_out:"60",conference:""+i.conference,call_group:""+i.call_group,barging:""+i.call_barging,extension_limit:""+i.extension_limit,file_storage_duration:""+i.file_storage_duration,file_storage_type:"",storage:""+i.storage,file_storage_size:""+i.file_storage_size,custom_prompt:""+i.custom_prompt,queue:""+i.queue,gateway_group_id:"",call_plan_id:"",find_me_follow_me:""+i.find_me_follow_me,one_to_one_video_call:""+i.one_to_one_video_call,is_circle:""+i.circle,circle_id:""+i.circle_id,is_feature_rate:""+i.feature,feature_rate_id:""+i.feature_id,custom_acl:""+i.custom_acl,is_caller_id:""+i.caller_id,broadcasting:""+i.broadcast,is_sms:""+i.sms,is_sms_type_custom:"0",sms_id:""+i.sms_id,teleconsultation:""+i.teleConsultancy,subscription:"1",feed_back_call:""+i.feedback_call,sticky_agent:""+i.sticky_agent,geo_tracking:""+i.geo_tracking,miss_call_alert:""+i.missed_call_alert,playback:""+i.playback,appointment:""+i.appointment,whatsapp:""+i.whatsapp,minute_plan:""+i.minute_plan,is_bundle_type:""+i.bundle,is_roaming_type:""+i.roaming,bundle_plan_id:""+i.bundle_plan_id,roaming_plan_id:""+i.roaming_plan_id,teleConsultancy_call_plan_id:""+i.teleConsultancy_call_plan_id,status:"1"}).then(function(e){e&&knex(table_1.Table.tbl_Package).insert({name:""+i.package_name,product_id:""+i.product,feature_id:""+e[0],duration:"0",renew:"0",status:"1",mapped:"0"}).then(function(e){return e?(s.apiInstance.log(200,"package create successfully.","","create Package."),a.status(200).send({status_code:200,message:"Package Created Successfully."})):(s.apiInstance.log(400,"Bad Request.","","create Package."),a.status(400).send({status_code:400,error:"Bad Request."}))}).catch(function(e){return s.apiInstance.log(400,"Bad Request.","","create Package."),a.status(400).send({status_code:400,error:"Bad Request."})})}).catch(function(e){return s.apiInstance.log(400,"Bad Request.","","create Package."),a.status(400).send({status_code:400,error:"Bad Request."})})})},e.prototype.getPackage=function(e,a,t,s){var i=this;if("0"==(e.user_type||1)){var n,r=e.query.productId||!1,e=e.query.circleId||!1;if(!r)return this.apiInstance.log(402,"Parameter Missing In Params - product type.","getPackage",s,"",""),a.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the product type in parameter"});"1"==r&&(n=knex.select("pf.*","p.id as package_id","p.name","p.duration","p.renew","gp.name as gateway_group","cp.name as call_plan","cr.name as circle_name","sms.name as sms_plan_name","bp.name as bundle_plan_name","bpr.name as roaming_plan_name").from(table_1.Table.tbl_Package+" as p").leftJoin(table_1.Table.tbl_Features+" as pf","p.feature_id","pf.id").leftJoin(table_1.Table.tbl_Map_Customer_Package+" as map","p.id","map.package_id").leftJoin(table_1.Table.tbl_Customer+" as c","c.id","map.customer_id").leftJoin(table_1.Table.tbl_Gateway_Group+" as gp","pf.gateway_group_id","gp.id").leftJoin(table_1.Table.tbl_Call_Plan+" as cp","pf.call_plan_id","cp.id").leftJoin(table_1.Table.tbl_circle+" as cr","cr.id","pf.circle_id").leftJoin(table_1.Table.tbl_SMS+" as sms","sms.id","pf.sms_id").leftJoin(table_1.Table.tbl_Bundle_Plan+" as bp","bp.id","pf.bundle_plan_id").leftJoin(table_1.Table.tbl_Bundle_Plan+" as bpr","bpr.id","pf.roaming_plan_id").where("p.product_id","=",r),e&&(n=n.andWhere("pf.circle_id",e))),console.log(n.toQuery()),(n=n.groupBy("p.id")).then(function(e){e.length?((e||[]).map(function(e){return delete e.id,delete e.voicemail_limit,delete e.minute_balance,delete e.gateway_group_id,delete e.created_at,delete e.updated_at,delete e.renew,delete e.gateway_group,e.id=e.package_id,delete e.package_id,e.bundle_plan_name=null==e.bundle_plan_name?"":e.bundle_plan_name,e.roaming_plan_name=null==e.roaming_plan_name?"":e.roaming_plan_name,e.circle_name=null==e.circle_name?"":e.circle_name,e.sms_plan_name=null==e.sms_plan_name?"":e.sms_plan_name,e}),a.json({status_code:200,message:"Package Listing.",data:e}),i.apiInstance.log(200,"Package Listing Info.","getPackage",s,"","")):(a.status(201).send({status_code:201,message:"No Data found"}),i.apiInstance.log(201,"No Data found.","getPackage",s,"","",""))}).catch(function(e){throw logger_util_1.errorLog(e),a.status(400).send({status_code:400,message:"Bad Request"}),i.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"getPackage",s,"","",""),e})}else this.apiInstance.log(403,"Forbidden - User has no permission for perform this action.","getPackage",s,"","",""),a.status(403).send({status_code:403,error:"Forbidden",message:"User has no permission for perform this action"})},e.prototype.packageUpdate=function(d,c,u){return __awaiter(this,void 0,void 0,function(){var a,t,s,i,n,r,l,o;return __generator(this,function(e){switch(e.label){case 0:if(a=d.body,t={},"0"!=(d.user_type||"1"))return[3,14];if(a.phone_book){if(3<a.phone_book.toString().length)return this.apiInstance.log(402,"phone book length should be less than 4.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid length.",message:"phone book length should be less than 4."})];if("number"!=typeof a.phone_book)return this.apiInstance.log(402,"phone number should be number","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"phone book should be number."})];if(a.phone_book<50)return this.apiInstance.log(402,"phone book can not be less than 50","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid length.",message:"phone book can not be less than 50"})];t.phone_book=a.phone_book}if(a.concurrent_call){if(3<a.concurrent_call.toString().length)return this.apiInstance.log(402,"concurrentcall length should be less than 4.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid length.",message:"concurrentcall length should be less than 4."})];if("number"!=typeof a.concurrent_call)return this.apiInstance.log(402,"concurrentcall should be number","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"concurrentcall should be number."})];t.concurrent_call=a.concurrent_call}if(a.extension_limit){if(4<a.extension_limit.toString().length)return this.apiInstance.log(402,"extensionLimit length should be less than 4.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid length.",message:"extensionLimit length should be less than 4."})];if("number"!=typeof a.extension_limit)return this.apiInstance.log(402,"extensionLimit should be number 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"extensionLimit should be number 1."})];t.extension_limit=a.extension_limit}if(a.appointment){if(0!=a.appointment&&1!=a.appointment)return this.apiInstance.log(402,"appointment should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"appointment should be either 0 or 1"})];t.appointment=a.appointment,1==a.appointment&&(t.storage=1,t.file_storage_duration=30,t.file_storage_size=1,t.custom_prompt=1)}if(a.caller_id){if("1"!=a.caller_id&&"0"!=a.caller_id)return this.apiInstance.log(402,"caller id should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"caller id should be either 0 or 1"})];t.is_caller_id=a.caller_id}if(a.call_barging){if("1"!=a.call_barging&&"0"!=a.call_barging)return this.apiInstance.log(402,"call barging should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"call barging should be either 0 or 1"})];t.barging=a.call_barging}if(a.call_group){if(1!=a.call_group&&0!=a.call_group)return this.apiInstance.log(402,"call group should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"call group should be either 0 or 1"})];t.call_group=a.call_group}if(a.call_transfer){if(1!=a.call_transfer&&0!=a.call_transfer)return this.apiInstance.log(402,"calltransfer should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"calltransfer should be either 0 or 1"})];t.call_transfer=a.call_transfer}if(a.click_to_call){if(1!=a.click_to_call&&0!=a.click_to_call)return this.apiInstance.log(402,"click to call should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"click to call should be either 0 or 1"})];t.click_to_call=a.click_to_call}if(a.conference){if(1!=a.conference&&0!=a.conference)return this.apiInstance.log(402,"conference should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"conference should be either 0 or 1"})];t.conference=a.conference}if(a.custom_acl){if("1"!=a.custom_acl&&"0"!=a.custom_acl)return this.apiInstance.log(402,"custom acl should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"custom acl should be either 0 or 1"})];t.custom_acl=a.custom_acl}if(a.feedback_call){if(1!=a.feedback_call&&0!=a.feedback_call)return this.apiInstance.log(402,"feedbackcall should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"feedbackcall should be either 0 or 1"})];t.feed_back_call=a.feedback_call}if(a.find_me_follow_me){if(1!=a.find_me_follow_me&&0!=a.find_me_follow_me)return this.apiInstance.log(402,"Find me Follow me should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"Find me Follow me should be either 0 or 1"})];t.find_me_follow_me=a.find_me_follow_me}if(a.forwarding){if(1!=a.forwarding&&0!=a.forwarding)return this.apiInstance.log(402,"Forwarding should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"Forwarding should be either 0 or 1"})];t.forward=a.forwarding}if(a.geotrack){if(1!=a.geotrack&&0!=a.geotrack)return this.apiInstance.log(402,"geo tracking should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"geo tracking should be either 0 or 1"})];t.geo_tracking=a.geotrack}if(a.storage)if(1==a.storage){if(t.storage=a.storage,t.file_storage_duration=a.file_storage_duration||30,t.file_storage_size=a.file_storage_size||1,1!=a.storage&&0!=a.storage)return this.apiInstance.log(402,"Storage should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"Storage should be either 0 or 1"})];if(a.recording){if(1!=a.recording&&0!=a.recording)return this.apiInstance.log(402,"Recording should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"Recording should be either 0 or 1"})];t.recording=a.recording}if(a.file_storage_duration){if(4<a.file_storage_duration.length)return this.apiInstance.log(402,"File Storage Duration should be less than 3 length.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invalid time duration.",message:"please provide valid duration."})];if(a.file_storage_duration<1)return this.apiInstance.log(402,"File Storage Duration can not be less than 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"File Storage Duration can not be less than 1"})]}if(a.file_storage_size&&6<a.file_storage_size.length)return this.apiInstance.log(402,"File Storage Size length should less than 6","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"size not accepted.",message:"Please provide valid size."})];if(a.custom_prompt){if(1!=a.custom_prompt&&0!=a.custom_prompt)return this.apiInstance.log(402,"Custom Prompt should be only 1.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"Custom Prompt should be 1"})];t.custom_prompt=a.custom_prompt}}else t.storage=a.storage,t.file_storage_duration="0",t.file_storage_size="0",t.recording="0",t.custom_prompt="0";else{if(a.recording)return this.apiInstance.log(402,"recording not access without storage.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Missing Parameter.",message:"recording not access without storage."})];if(a.file_storage_size)return this.apiInstance.log(402,"File Storag Size not access without storage.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Missing Parameter.",message:"File Storag Size not access without storage."})];if(a.file_storage_duration)return this.apiInstance.log(402,"File Storag Duration not access without storage.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Missing Parameter.",message:"File Storag Duration not access without storage."})];if(a.custom_prompt)return this.apiInstance.log(402,"CustomPrompts not access without storage.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Missing Parameter.",message:"CustomPrompt not access without storage."})]}if(a.missed_call_alert){if(1!=a.missed_call_alert&&0!=a.missed_call_alert)return this.apiInstance.log(402,"missed call alert should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"missed call alert should be either 0 or 1"})];t.miss_call_alert=a.missed_call_alert}if(a.one_to_one_video_call){if(1!=a.one_to_one_video_call&&0!=a.one_to_one_video_call)return this.apiInstance.log(402,"One to one video call should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"OnetoOne video call should be either 0 or 1"})];t.one_to_one_video_call=a.one_to_one_video_call}if(a.paging&&(t.paging=a.paging,1!=a.paging&&0!=a.paging))return this.apiInstance.log(402,"Pagging should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"Pagging should be either 0 or 1"})];if(a.playback&&(t.playback=a.playback,0!=a.playback&&1!=a.playback))return this.apiInstance.log(402,"Playback should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"Playback should be either 0 or 1"})];if(a.speed_dial&&(t.speed_dial=a.speed_dial,1!=a.speed_dial&&0!=a.speed_dial))return this.apiInstance.log(402,"Speed dial should be 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"Speed dial should be 0 or 1"})];if(a.ivr||a.moh||a.queue||a.broadcast){if(1!=a.ivr&&0!=a.ivr&&1!=a.moh&&0!=a.moh&&1!=a.queue&&0!=a.queue&&1!=a.broadcast&&0!=a.broadcast)return this.apiInstance.log(402,"Please provide valid value.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"please provide valid value."})];t.storage=1,t.file_storage_duration=a.file_storage_duration||30,t.file_storage_size=a.file_storage_size||1,t.ivr=a.ivr||0,t.music_on_hold=a.moh||0,t.queue=a.queue||0,t.broadcasting=a.broadcast||0,(a.ivr||a.queue||a.broadcast)&&(t.custom_prompt=1)}return(s=void 0,a.sms)?1!=a.sms&&0!=a.sms?(this.apiInstance.log(402,"sms should be either 0 or 1","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"sms should be either 0 or 1"})]):(t.is_sms=a.sms,1!=a.sms?[3,2]:a.sms_id?"number"!=typeof a.sms_id?(this.apiInstance.log(402,"SmsId should be number","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"Sms id should be number."})]):[4,this.validateInstance.ValidateSmsExist(a.sms_id)]:(this.apiInstance.log(402,"Please provide sms id.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Parameter Missing.",message:"Please provide sms id."})])):[3,2];case 1:if(!(s=e.sent()))return this.apiInstance.log(402,"sms does not exist.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invalid data.",message:"Please provide valid sms data."})];t.sms_id=s.id,e.label=2;case 2:return a.whatsapp&&(t.whatsapp=a.whatsapp,1!=a.whatsapp&&0!=a.whatsapp)?(this.apiInstance.log(402,"whatsapp should be only 1.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"whatsapp should be 1"})]):a.sticky_agent&&(t.sticky_agent=a.sticky_agent,1!=a.sticky_agent&&0!=a.sticky_agent)?(this.apiInstance.log(402,"sticky agent should be only 1.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"sticky agent should be 1"})]):a.outbound?(t.outbound_call=a.outbound,1!=a.outbound&&0!=a.outbound?(this.apiInstance.log(402,"outbound should be either 0 or 1.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invalid value.",message:"outbound should be either 0 or 1."})]):1!=a.outbound||a.circle?[3,4]:a.call_plan_id?(t.call_plan_id=a.call_plan_id,[4,this.validateInstance.validateCallPlanExist(a.call_plan_id)]):(this.apiInstance.log(402,"please provide call plan id.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invalid value.",message:"please provide call plan id."})])):[3,7];case 3:if(""==e.sent())return this.apiInstance.log(402,"please provide valid callplan id.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invalid value.",message:"please provide valid callplan id."})];e.label=4;case 4:return a.circle?1!=a.circle&&0!=a.circle?(this.apiInstance.log(402,"circle should be either 0 or 1.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invalid value.",message:"circle should be either 0 or 1."})]):1!=a.circle||1!=a.outbound?[3,7]:(t.call_plan_id=a.call_plan_id,t.circle_id=a.circle_id,t.is_circle=a.circle,a.circle_id?"number"!=typeof a.circle_id?(this.apiInstance.log(402,"circle id should be number.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invalid value.",message:"circle id should be number.."})]):a.call_plan_id?"number"!=typeof a.call_plan_id?(this.apiInstance.log(402,"call plan id should be number.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invalid value.",message:"call plan id should be number.."})]):[4,this.validateInstance.validateCircleExist(a.circle_id)]:(this.apiInstance.log(402,"please provide call plan id based on circle.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invalid value.",message:"please provide call plan id based on circle."})]):(this.apiInstance.log(402,"please provide circle id.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Missing Parameter.",message:"please provide the circle id."})])):[3,7];case 5:return 1==e.sent()?(this.apiInstance.log(402,"please provide valid circle id","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invalid data.",message:"Please provide valid circle id."})]):[4,this.validateInstance.validateCallPlanBasedOnCircle(a.call_plan_id,a.circle_id)];case 6:if(0==e.sent())return this.apiInstance.log(402,"please provide valid circle id","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"does not exist.",message:"call plan does not exist for circle."})];e.label=7;case 7:return a.minute_plan?1!=a.minute_plan&&0!=a.minute_plan?(this.apiInstance.log(402,"Minute plan should be either 0 or 1.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid parameter",message:"Minute plan should be either 0 or 1"})]):1!=a.minute_plan?[3,13]:(t.minute_plan=a.minute_plan,a.bundle||a.roaming||a.teleConsultancy?a.bundle?(t.is_bundle_type=a.bundle,t.bundle_plan_id=a.bundle_plan_id,1!=a.bundle&&0!=a.bundle?(this.apiInstance.log(402,"bundle plan should be either 0 or 1.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid parameter",message:"bundle plan should be either 0 or 1"})]):1!=a.bundle?[3,9]:a.bundle_plan_id?"number"!=typeof a.bundle_plan_id?(this.apiInstance.log(402,"bundle plan id should be number.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"bundle plan id should be number."})]):[4,this.validateInstance.validateBundle(1)]:(this.apiInstance.log(402,"please provide bundle plan id.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Missing Parameter.",message:"please provide bundle plan id."})])):[3,9]:(this.apiInstance.log(402,"please choose atleast one from bundle, roaming, teleconsulatat.","packageupdate",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"please choose atleast one from bundle, roaming, teleconsulatat."})])):[3,13];case 8:for(i=e.sent(),o=l=0;o<i.length;o++){if(i[o].id==a.bundle_plan_id){l=0;break}l++}if(0!=l)return this.apiInstance.log(400,"bundle plan id does not match.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invallid data.",message:"Please provide valid bundle call plan id."})];e.label=9;case 9:return a.roaming?(t.is_roaming_type=a.roaming,t.roaming_plan_id=a.roaming_plan_id,1!=a.roaming&&0!=a.roaming?(this.apiInstance.log(402,"roaming plan should be either 0 or 1.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid parameter",message:"roaming plan should be either 0 or 1"})]):1!=a.roaming?[3,11]:a.roaming_plan_id?"number"!=typeof a.roaming_plan_id?(this.apiInstance.log(402,"roaming plan id should be number.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"roaming plan id should be number."})]):[4,this.validateInstance.validateBundle(2)]:(this.apiInstance.log(402,"please provide roaming plan id.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Missing-Parameter.",message:"please provide roaming plan id."})])):[3,11];case 10:for(n=e.sent(),o=l=0;o<n.length;o++){if(n[o].id==a.roaming_plan_id){l=0;break}l++}if(0!=l)return this.apiInstance.log(400,"roaming plan id does not match.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invalid data.",message:"Please provide valid roaming call plan id."})];e.label=11;case 11:return a.teleConsultancy?(t.teleconsultation=a.teleConsultancy,t.teleConsultancy_call_plan_id=a.teleConsultancy_call_plan_id,1!=a.teleConsultancy&&0!=a.teleConsultancy?(this.apiInstance.log(402,"teleConsultancy should be either 0 or 1.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid parameter",message:"teleConsultancy should be either 0 or 1"})]):1!=a.teleConsultancy?[3,13]:a.teleConsultancy_call_plan_id?"number"!=typeof a.teleConsultancy_call_plan_id?(this.apiInstance.log(402,"teleConsultancy plan id should be number.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"invalid value.",message:"teleConsultancy plan id should be number."})]):[4,this.validateInstance.validateBundle(4)]:(this.apiInstance.log(402,"please provide teleConsultancy plan id.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Missing-Parameter.",message:"please provide teleConsultancy plan id."})])):[3,13];case 12:for(r=e.sent(),o=l=0;o<r.length;o++){if(r[o].id==a.teleConsultancy_call_plan_id){l=0;break}l++}if(0!=l)return this.apiInstance.log(400," plan id does not match.","","",JSON.stringify(a)),[2,c.status(402).send({status_code:402,error:"Invalid data.",message:"Please provide valid teleConsultancy call plan id."})];e.label=13;case 13:this.updatepackage(d,c,u,t,a),e.label=14;case 14:return[2]}})})},e.prototype.updatepackage=function(e,a,t,s,i){var n=this,e=e.body;if(!e.packageid)return this.apiInstance.log(402,"Please provide package id.","packageupdate",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Missing Parameter.",message:"Please provide package id."});if("number"!=typeof e.packageid)return this.apiInstance.log(402,"Please provide valid id.","packageupdate",JSON.stringify(i)),a.status(402).send({status_code:402,error:"Invalid data.",message:"package id should be number."});knex(table_1.Table.tbl_Package).select("feature_id").where("id",i.packageid).then(function(e){""!=s&&knex(table_1.Table.tbl_Features).update(s).where("id",e[0].feature_id).then(function(e){return e?(n.apiInstance.log(200,"Package Update Successfully..","packageupdate",JSON.stringify(s)),a.status(200).send({status_code:200,message:"Package update successfully with features."})):(n.apiInstance.log(402,"Package Not Update.","packageupdate",JSON.stringify(i)),a.status(402).send({status_code:400,error:"Bad Request.",message:"Package Not Update."}))}).catch(function(e){return n.apiInstance.log(400,"Package Not Update.","",JSON.stringify(i)),a.status(400).send({status_code:400,error:"Bad Request."})})}).catch(function(e){return n.apiInstance.log(400,"Package Not Update.","",JSON.stringify(i)),a.status(400).send({status_code:400,error:"Bad Request."})})},e}();exports.PackageService=PackageService;