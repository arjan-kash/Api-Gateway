"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LoginService=void 0;var logger_util_1=require("../utils/logger.util"),table_1=require("../dba/table"),api_logs_1=require("../utils/api-logs"),Hash=require("crypto-js/pbkdf2"),config=require("../config"),JWTUtil=require("../utils/jwt.util"),knex=require("../dba/knex.db"),LoginService=function(){function e(){this.apiInstance=new api_logs_1.ApiLogs,this.encrypt=new JWTUtil}return e.prototype.apiGatewayLogin=function(s,t,e){var a=this,o=s.body;if(!o.username)return this.apiInstance.log(402,"Parameter Missing - username.","PBXLogin","pbx"),t.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the username"});if(!o.password)return this.apiInstance.log(402,"Parameter Missing - password.","PBXLogin","pbx"),t.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the password"});var n=knex.select("*").from(table_1.Table.tbl_Extension_Master+" as ext").where("ext.ext_number","=",""+o.username).andWhere("ext.sip_password","=",""+o.password);console.log(n.toQuery()),n.then(function(e){console.log(e),e.length?(e=(new(require("../utils/jwt.util"))).generateAccessToken(e[0].id,e[0].package_id,e[0].customer_id,e[0].ext_number,"","","6",s.headers.type),t.json({status_code:200,token:e,message:"You have successfully logged in."}),a.apiInstance.log(200,"You have successfully logged in.","PBXLogin","pbx","",o.username)):(t.status(202).send({status_code:202,error:"User inactive / Deleted",message:"user does not exist"}),a.apiInstance.log(202,"user does not exist.","PBXLogin","pbx","","",JSON.stringify(o)))}).catch(function(e){throw t.status(400).send({status_code:400,message:"Bad Request"}),a.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"PBXLogin","pbx","","",JSON.stringify(o)),e})},e.prototype.apiGatewayCustomerLogin=function(t,a,e){var o=this,n=t.body;n.user_type;knex.select("api_token").from(table_1.Table.tbl_Customer).where("username",n.username).then(function(e){if("1"==e[0].api_token){if(!n.username)return o.apiInstance.log(402,"Parameter Missing - username.","PBXCustomerLogin","pbx"),a.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the username"});if(!n.password)return o.apiInstance.log(402,"Parameter Missing - password.","PBXCustomerLogin","pbx"),a.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the password"});e=o.encrypt.cipher(config.jwt.appSecret)(n.password);console.log(e),knex.raw('Call login_credential("'+n.username+'","'+e+"\",'"+n.password+'\' ,"1")').then(function(e){var s=e[0][0][0];console.log("customer api login response is",s.role),e.length?(e=(new(require("../utils/jwt.util"))).generateAccessToken(s.id,"",s.customer_id,"",s.token,s.api_token,s.role,t.headers.type),a.json({status_code:200,token:e,c2c_token:s.token,callback_url:s.callback_url,message:"You have successfully logged in."}),o.apiInstance.log(200,"You have successfully logged in.","PBXCustomerLogin","pbx","",n.username)):(a.status(202).send({status_code:202,error:"User inactive / Deleted",message:"user does not exist"}),o.apiInstance.log(202,"user does not exist.","PBXCustomerLogin","pbx","","",JSON.stringify(n)))}).catch(function(e){throw logger_util_1.errorLog(e),console.log(e.sqlMessage),a.status(400).send({status_code:400,message:"Bad Request : "+e.sqlMessage}),o.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"PBXCustomerLogin","pbx","","",JSON.stringify(n)),e})}else o.apiInstance.log("You can not access it.","CustomerLogin","","",JSON.stringify(n)),a.status(202).send({status_code:202,message:"api is inactive."})}).catch(function(e){logger_util_1.errorLog(e),console.log(e.sqlMessage),a.status(400).send({status_code:400,message:"Bad Request : "+e.sqlMessage})})},e.prototype.softphoneLogin=function(a,o,e){var n=this,r=a.body;return r.username?r.password?void knex.select("id","package_id","customer_id","ext_number","token","role_id","package_id as packageid","first_name as firstname","last_name as lastname","send_misscall_notification as misscallnotify","balance_restriction as balrestrict","caller_id_name as calleridname","email","mobile","codec","voicemail","dnd","outbound","recording","speed_dial as speeddial","forward","black_list as blacklist","call_transfer as transfer","total_min_bal as minbalance","used_min as usedmin","roaming","outbound_sms_notification as outboundsmsnotify","admin","ringtone","find_me_follow_me as fmfm",knex.raw("JSON_UNQUOTE(json_extract(favorite,'$.ext_number')) as favorite")).from(table_1.Table.tbl_Extension_Master+" as ext").where("ext.ext_number","=",""+r.username).andWhere("ext.sip_password","=",""+r.password).then(function(t){0<t.length?knex(table_1.Table.tbl_SoftPhone_Logs).insert({username:""+a.body.username,device_info:""+a.body.device_info,mac_address:""+a.body.mac_address,network_info:""+a.body.network_info,operator_info:""+a.body.operator_info,latitude:""+a.body.latitude,longitude:""+a.body.longitude}).then(function(e){var s;0<e.length?(s=t[0],e=(new(require("../utils/jwt.util"))).generateAccessToken(t[0].id,t[0].package_id,t[0].customer_id,t[0].ext_number,t[0].token,t[0].role_id,a.headers.type),delete s.id,delete s.package_id,delete s.customer_id,delete s.ext_number,delete s.token,o.json({data:s,token:e,status_code:200,message:"You have successfully logged in."}),n.apiInstance.log(200,"You have successfully logged in.","softphoneLogin","sp","",r.username)):(o.status(401).send({error:"Unauthorized",message:"Softphone log Creation error"}),n.apiInstance.log(401,"Softphone log Creation error.","softphoneLogin","sp","","",JSON.stringify(r)))}).catch(function(e){throw logger_util_1.errorLog(e),o.status(400).send({status_code:400,message:"Bad Request"}),n.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"softphoneLogin","sp","","",JSON.stringify(r)),e}):(o.status(202).send({status_code:202,error:"User inactive / Deleted",message:"user does not exist"}),n.apiInstance.log(202,"user does not exist.","softphoneLogin","sp","","",JSON.stringify(r)))}).catch(function(e){throw logger_util_1.errorLog(e),o.status(400).send({status_code:400,message:"Bad Request: "+e.sqlMessage}),n.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"SoftphoneLogin","sp","","",JSON.stringify(r)),e}):(this.apiInstance.log(402,"Parameter Missing - password.","softphoneLogin","sp"),o.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the password"})):(this.apiInstance.log(402,"Parameter Missing - username.","softphoneLogin","sp"),o.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the username"}))},e.prototype.softphoneCustomerLogin=function(t,a,e){var o=this,n=t.body;if(!n.username)return this.apiInstance.log(402,"Parameter Missing - username.","softphoneCustomerLogin","sp"),a.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the username"});if(!n.password)return this.apiInstance.log(402,"Parameter Missing - password.","softphoneCustomerLogin","sp"),a.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the password"});var s=this.encrypt.cipher(config.jwt.appSecret)(n.password);console.log(s),knex.raw('Call login_credential("'+n.username+'","'+s+"\",'"+n.password+'\' ,"1")').then(function(e){var s=e[0][0][0];console.log(s),e.length?(s=(new(require("../utils/jwt.util"))).generateAccessToken(s.id,"",s.customer_id,"",s.token,s.role,t.headers.type),a.json({status_code:200,token:s,message:"You have successfully logged in."}),o.apiInstance.log(200,"You have successfully logged in.","softphoneCustomerLogin","sp","",n.username)):(a.status(202).send({status_code:202,error:"User inactive / Deleted",message:"user does not exist"}),o.apiInstance.log(202,"user does not exist.","softphoneCustomerLogin","sp","","",JSON.stringify(n)))}).catch(function(e){throw logger_util_1.errorLog(e),console.log(e.sqlMessage),a.status(400).send({status_code:400,message:"Bad Request : "+e.sqlMessage}),o.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"softphoneCustomerLogin","sp","","",JSON.stringify(n)),e})},e.prototype.softphoneForgotPassword=function(e,s,t){var a=this,o=e.body;return o.username?o.email?void knex.select("*").from(table_1.Table.tbl_Extension_Master+" as ext").where("ext.ext_number","=",""+o.username).then(function(e){e.length?(s.json({status_code:200,message:"Your reset password has been sent to a registered email."}),a.apiInstance.log(200,"Reset password.","softphoneForgotPassword","sp","",o.username)):(s.status(202).send({status_code:202,error:"User inactive / Deleted",message:"user does not exist"}),a.apiInstance.log(202,"user does not exist.","softphoneForgotPassword","sp","","",JSON.stringify(o)))}).catch(function(e){throw logger_util_1.errorLog(e),s.status(400).send({status_code:400,message:"Bad Request"}),a.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"softphoneForgotPassword","sp","","",JSON.stringify(o)),e}):(this.apiInstance.log(402,"Parameter Missing - email.","softphoneForgotPassword","sp"),s.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the email"})):(this.apiInstance.log(402,"Parameter Missing - username.","softphoneForgotPassword","sp"),s.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the username"}))},e.prototype.pbxForgotPassword=function(e,s,t){var a=this,o=e.body;return o.username?o.email?void knex.select("*").from(table_1.Table.tbl_Extension_Master+" as ext").where("ext.ext_number","=",""+o.username).then(function(e){e.length?(s.json({status_code:200,message:"Your reset password has been sent to a registered email."}),a.apiInstance.log(200,"Reset password.","pbxForgotPassword","pbx","",o.username)):(s.status(202).send({status_code:202,error:"User inactive / Deleted",message:"user does not exist"}),a.apiInstance.log(202,"user does not exist.","pbxForgotPassword","pbx","","",JSON.stringify(o)))}).catch(function(e){throw logger_util_1.errorLog(e),s.status(400).send({status_code:400,message:"Bad Request"}),a.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"pbxForgotPassword","pbx","","",JSON.stringify(o)),e}):(this.apiInstance.log(402,"Parameter Missing - email.","PBXForgotPassword","pbx"),s.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the email"})):(this.apiInstance.log(402,"Parameter Missing - username.","PBXForgotPassword","pbx"),s.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the username"}))},e.prototype.crmLogin=function(a,o,e){var n=this,r=a.body;return r.username?r.password?void knex.select("id","package_id","customer_id","ext_number","token","package_id as packageid","first_name as firstname","last_name as lastname","send_misscall_notification as misscallnotify","balance_restriction as balrestrict","caller_id_name as calleridname","email","mobile","codec","voicemail","dnd","outbound","recording","speed_dial as speeddial","forward","black_list as blacklist","call_transfer as transfer","total_min_bal as minbalance","used_min as usedmin","roaming","outbound_sms_notification as outboundsmsnotify","admin","ringtone","find_me_follow_me as fmfm",knex.raw("JSON_UNQUOTE(json_extract(favorite,'$.favorite')) as favorite")).from(table_1.Table.tbl_Extension_Master+" as ext").where("ext.ext_number","=",""+r.username).andWhere("ext.sip_password","=",""+r.password).then(function(t){0<t.length?knex(table_1.Table.tbl_SoftPhone_Logs).insert({username:""+a.body.username,device_info:""+a.body.device_info,mac_address:""+a.body.mac_address,network_info:""+a.body.network_info,operator_info:""+a.body.operator_info,latitude:""+a.body.latitude,longitude:""+a.body.longitude}).then(function(e){var s;0<e.length?(s=t[0],e=(new(require("../utils/jwt.util"))).generateAccessToken(t[0].id,t[0].package_id,t[0].customer_id,t[0].ext_number,t[0].token,"6",a.headers.type),delete s.id,delete s.package_id,delete s.customer_id,delete s.ext_number,delete s.token,o.json({data:s,token:e,status_code:200,message:"You have successfully logged in."}),n.apiInstance.log(200,"You have successfully logged in.","crmLogin","crm","",r.username)):(o.status(401).send({error:"Unauthorized",message:"crm log Creation error"}),n.apiInstance.log(401,"crm log Creation error.","crmLogin","crm","","",JSON.stringify(r)))}).catch(function(e){throw logger_util_1.errorLog(e),o.status(400).send({status_code:400,message:"Bad Request"}),n.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"crmLogin","crm","","",JSON.stringify(r)),e}):(o.status(202).send({status_code:202,error:"User inactive / Deleted",message:"user does not exist"}),n.apiInstance.log(202,"user does not exist.","crmLogin","crm","","",JSON.stringify(r)))}).catch(function(e){throw logger_util_1.errorLog(e),o.status(400).send({status_code:400,message:"Bad Request: "+e.sqlMessage}),n.apiInstance.log(400,"Bad Request: "+e.sqlMessage,"crmLogin","crm","","",JSON.stringify(r)),e}):(this.apiInstance.log(402,"Parameter Missing - password.","crmLogin","crm"),o.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the password"})):(this.apiInstance.log(402,"Parameter Missing - username.","crmLogin","crm"),o.status(402).send({status_code:402,error:"Parameter Missing",message:"Please enter the username"}))},e}();exports.LoginService=LoginService;